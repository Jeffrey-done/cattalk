<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ«å’ªèŠå¤© | Cat Talk</title>
    <script>
        // åœ¨CSSåŠ è½½å‰åº”ç”¨ä¿å­˜çš„ä¸»é¢˜ï¼Œé¿å…é—ªçƒ
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme) {
                document.documentElement.dataset.theme = savedTheme;
            } else if (prefersDarkMode) {
                document.documentElement.dataset.theme = 'dark';
                localStorage.setItem('theme', 'dark');
            }
        })();
    </script>
    <style>
        :root {
            /* ä¸»è‰²è°ƒ */
            --primary-color: #4285f4;
            --primary-light: #7baaf7;
            --primary-dark: #3367d6;
            
            /* ä¸­æ€§è‰² */
            --neutral-100: #f7f9fc;
            --neutral-200: #e0e0e0;
            --neutral-300: #c5c5c5;
            --neutral-400: #9e9e9e;
            --neutral-500: #757575;
            --neutral-600: #616161;
            --neutral-700: #424242;
            --neutral-800: #212121;
            --neutral-900: #1a1a1a;
            
            /* è¯­ä¹‰è‰² */
            --info-color: #4285f4;
            --success-color: #34a853;
            --warning-color: #fbbc05;
            --error-color: #ea4335;
            
            /* äº®è‰²æ¨¡å¼ä¸‹çš„å˜é‡ */
            --bg-color: var(--neutral-100);
            --text-color: var(--neutral-800);
            --chat-bg: white;
            --border-color: var(--neutral-200);
            --msg-bg: var(--neutral-200);
            --own-msg-bg: var(--primary-light);
            --input-bg: white;
            --button-bg: var(--primary-color);
            --button-hover: var(--primary-dark);
            --shadow-color: rgba(0,0,0,0.05);
            --shadow-hover: rgba(0,0,0,0.15);
            --primary-color-rgb: 66, 133, 244;
        }
        
        [data-theme="dark"] {
            /* æš—è‰²æ¨¡å¼ä¸‹çš„å˜é‡ */
            --bg-color: var(--neutral-900);
            --text-color: var(--neutral-200);
            --chat-bg: var(--neutral-800);
            --border-color: var(--neutral-700);
            --msg-bg: var(--neutral-700);
            --own-msg-bg: #2c405e;
            --input-bg: var(--neutral-700);
            --button-bg: var(--primary-dark);
            --button-hover: var(--primary-color);
            --shadow-color: rgba(0,0,0,0.2);
            --shadow-hover: rgba(0,0,0,0.4);
            --primary-color-rgb: 51, 103, 214;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
            letter-spacing: -0.5px;
        }
        
        #chat {
            height: 450px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 15px;
            background-color: var(--chat-bg);
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: var(--neutral-400) transparent;
        }
        
        #chat::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat::-webkit-scrollbar-thumb {
            background-color: var(--neutral-400);
            border-radius: 3px;
        }
        
        #chat::-webkit-scrollbar-track {
            background-color: transparent;
        }
        
        .message {
            margin: 10px 0;
            padding: 12px 16px;
            background: var(--msg-bg);
            border-radius: 18px 18px 18px 4px;
            max-width: 80%;
            word-break: break-word;
            position: relative;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 1px 2px var(--shadow-color);
            clear: both;
            float: left;
            transition: all 0.3s ease;
        }
        
        .message:hover {
            box-shadow: 0 3px 8px var(--shadow-hover);
        }
        
        .message.own-message {
            background: var(--own-msg-bg);
            border-radius: 18px 18px 4px 18px;
            float: right;
            text-align: right;
        }
        
        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        
        .avatar:hover {
            transform: scale(1.05);
        }
        
        .message.own-message .avatar {
            margin-right: 0;
            margin-left: 12px;
        }
        
        .cat-emoji {
            font-size: 24px;
            line-height: 1;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message.own-message .user-info {
            flex-direction: row-reverse;
        }
        
        .message-content {
            margin-top: 5px;
            line-height: 1.5;
        }
        
        .message-header {
            font-size: 0.8rem;
            color: var(--neutral-500);
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .message-sender {
            font-weight: 600;
            color: var(--neutral-600);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--neutral-400);
        }
        
        .message-text {
            margin-top: 6px;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .input-area {
            display: flex;
            gap: 12px;
            position: relative;
            margin-top: 15px;
            background-color: var(--chat-bg);
            padding: 12px;
            border-radius: 24px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        #input {
            flex-grow: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        #input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        button {
            padding: 0 20px;
            height: 44px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 22px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }
        
        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .status {
            color: var(--neutral-500);
            font-size: 0.9em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            
            .theme-switch {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
            }
            
            #chat {
                height: calc(100vh - 220px);
            }
            
            .message {
                max-width: 95%;
                padding: 8px 12px;
            }
            
            .emoji-panel {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .status {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .input-area {
                flex-wrap: wrap;
            }
            
            .send-text {
                display: none;
            }
        }
        
        @media (min-width: 1200px) {
            body {
                max-width: 1000px;
            }
            
            #chat {
                height: 550px;
            }
        }
        
        #nickname-form {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            background-color: var(--chat-bg);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        #nickname {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            flex-grow: 1;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        #nickname:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        .typing-indicator {
            font-style: italic;
            color: var(--neutral-500);
            height: 20px;
            margin-top: 5px;
            animation: pulse 1.5s infinite;
        }
        
        .typing-indicator.active {
            animation: pulse 1.5s infinite;
        }
        
        /* è¡¨æƒ…é€‰æ‹©å™¨æ ·å¼ */
        .emoji-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background-color: var(--neutral-200);
            width: 44px;
            height: 44px;
        }
        
        [data-theme="dark"] .emoji-button {
            background-color: var(--neutral-700);
        }
        
        .emoji-button:hover {
            background-color: var(--neutral-300);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .emoji-button:hover {
            background-color: var(--neutral-600);
        }
        
        .emoji-panel {
            position: absolute;
            bottom: 60px;
            left: 0;
            background-color: var(--chat-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            z-index: 10;
            animation: fadeIn 0.3s ease;
            display: none;
            transition: all 0.3s ease;
        }
        
        .emoji-panel.active {
            display: grid;
        }
        
        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .emoji-item:hover {
            background-color: var(--msg-bg);
            transform: scale(1.1);
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background-color: var(--button-bg);
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        background-color 0.3s ease;
            z-index: 100;
        }
        
        .theme-switch:hover {
            background-color: var(--button-hover);
            transform: translateY(-3px) rotate(15deg);
        }
        
        .theme-switch:active {
            transform: translateY(0) rotate(0);
        }
        
        /* æ·»åŠ å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .icon-button {
            background: none;
            border: none;
            font-size: 1.2rem;
            padding: 4px;
            cursor: pointer;
            border-radius: 50%;
            color: var(--text-color);
            transition: all 0.2s ease;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .icon-button:hover {
            background-color: var(--neutral-200);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .icon-button:hover {
            background-color: var(--neutral-700);
        }
        
        /* å¢å¼ºå¯è®¿é—®æ€§ */
        :focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* æ–°å¢å¡ç‰‡é¢æ¿æ ·å¼ */
        .card-panel {
            background-color: var(--chat-bg);
            border-radius: 16px;
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .card-panel:hover {
            box-shadow: 0 6px 16px var(--shadow-hover);
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
        }
        
        .logo-area h1 {
            margin: 0;
        }
        
        /* ç”¨æˆ·çŠ¶æ€æ ·å¼ */
        .status-label {
            font-size: 0.9rem;
            color: var(--neutral-500);
            margin-right: 8px;
        }
        
        .user-status, .online-status {
            display: flex;
            align-items: center;
            background-color: rgba(var(--primary-color-rgb), 0.05);
            padding: 6px 12px;
            border-radius: 8px;
        }
        
        .badge, .user-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .user-badge {
            background-color: var(--success-color);
        }
        
        /* èŠå¤©å®¹å™¨ */
        .chat-container {
            padding: 0;
            overflow: hidden;
        }
        
        .chat-container #chat {
            border: none;
            box-shadow: none;
            margin-bottom: 0;
            height: 400px;
        }
        
        /* å‘é€æŒ‰é’® */
        .send-button {
            gap: 6px;
        }
        
        .send-icon {
            font-size: 1.2rem;
        }
        
        /* è¡¨æƒ…å®¹å™¨ */
        .emoji-container {
            position: relative;
        }
        
        /* æ¶ˆæ¯æ ·å¼å¢å¼º */
        .message-footer {
            font-size: 0.7rem;
            color: var(--neutral-400);
            text-align: right;
            margin-top: 4px;
        }
        
        /* è¾“å…¥æ¡†å®¹å™¨ */
        .input-area {
            margin-bottom: 15px;
        }
        
        /* å£°éŸ³æ§åˆ¶ */
        .sound-control {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        /* è¡¨å•æ ‡é¢˜ */
        .form-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* é¡µè„š */
        .app-footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            color: var(--neutral-500);
            font-size: 0.85rem;
        }
        
        /* ä¸»é¢˜è¿‡æ¸¡åŠ¨ç”» */
        .theme-transition * {
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease !important;
        }
        
        /* å¢å¼ºåŠ¨ç”»æ•ˆæœ */
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* åº”ç”¨åŠ¨ç”» */
        .message:not(.own-message) {
            animation: slideIn 0.3s ease forwards;
        }
        
        .message.own-message {
            animation: slideInRight 0.3s ease forwards;
        }
        
        .card-panel {
            animation: scaleIn 0.4s ease-out forwards;
        }
        
        /* æŒ‰é’®ç‚¹å‡»ç‰¹æ•ˆ */
        button:active {
            transform: scale(0.95);
        }
        
        /* æ¶ˆæ¯æ—¶é—´çº¿ */
        .chat-container #chat {
            position: relative;
        }
        
        .chat-container #chat::after {
            content: '';
            position: absolute;
            left: 35px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--border-color);
            z-index: 0;
            opacity: 0.5;
        }
        
        /* æ»šåŠ¨æŒ‡ç¤ºå™¨ */
        .scroll-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 2px 8px var(--shadow-color);
            z-index: 10;
        }
        
        .scroll-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* è¾“å…¥æ¡†ç„¦ç‚¹å¢å¼º */
        #input:focus, #nickname:focus {
            transform: translateY(-2px);
        }
        
        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(30px);
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
            text-align: center;
            min-width: 200px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* é€‰ä¸­æ–‡æœ¬é¢œè‰² */
        ::selection {
            background-color: var(--primary-light);
            color: white;
        }
        
        /* æ»šåŠ¨æ¡ä¼˜åŒ– */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--neutral-400) transparent;
        }
        
        *::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        *::-webkit-scrollbar-thumb {
            background-color: var(--neutral-400);
            border-radius: 3px;
        }
        
        *::-webkit-scrollbar-track {
            background-color: transparent;
        }
        
        /* åª’ä½“ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .media-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background-color: var(--neutral-200);
            width: 44px;
            height: 44px;
        }
        
        [data-theme="dark"] .media-button {
            background-color: var(--neutral-700);
        }
        
        .media-button:hover {
            background-color: var(--neutral-300);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .media-button:hover {
            background-color: var(--neutral-600);
        }
        
        .media-upload {
            position: relative;
        }
        
        /* åª’ä½“é¢„è§ˆåŒºåŸŸæ ·å¼ */
        .media-preview-container {
            background-color: var(--chat-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 10px 0;
            overflow: hidden;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .media-preview-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }
        
        .media-preview-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            max-height: 160px;
            overflow-y: auto;
        }
        
        .file-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2px 5px;
            font-size: 0.7rem;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 0 0 8px 8px;
        }
        
        .media-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: transform 0.2s ease;
        }
        
        .media-item:hover {
            transform: scale(1.05);
        }
        
        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-item .remove-media {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .media-item:hover .remove-media {
            opacity: 1;
        }
        
        /* æ¶ˆæ¯ä¸­çš„åª’ä½“æ ·å¼ */
        .message-media {
            margin-top: 8px;
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .message-media img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .message-media img:hover {
            transform: scale(1.02);
        }
        
        .message-media video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
        }
        
        /* åª’ä½“åŠ è½½è¿›åº¦æ ·å¼ */
        .upload-progress {
            height: 4px;
            background-color: var(--neutral-200);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0;
            transition: width 0.3s ease;
        }
        
        /* å‡çº§åçš„åª’ä½“å…¨å±é¢„è§ˆ */
        .media-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .media-fullscreen.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .media-fullscreen img, .media-fullscreen video {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .media-fullscreen .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .media-fullscreen .close-fullscreen:hover {
            opacity: 1;
            transform: scale(1.1);
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-area">
            <h1>ğŸ± çŒ«å’ªèŠå¤© | Cat Talk</h1>
        </div>
        <div class="theme-switch" id="theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
            ğŸŒ™
        </div>
    </header>
    
    <div id="nickname-form" class="card-panel">
        <div class="form-title">è®¾ç½®ä½ çš„æ˜µç§°</div>
        <input type="text" id="nickname" placeholder="è¾“å…¥æ‚¨å–œæ¬¢çš„æ˜µç§°" maxlength="20">
        <button onclick="setNickname()">ä¿å­˜</button>
    </div>

    <div class="status card-panel">
        <div class="user-status">
            <span class="status-label">æ‚¨çš„èº«ä»½:</span>
            <div class="user-badge">
                <span id="user-id"></span>
            </div>
        </div>
        <div class="online-status">
            <span class="status-label">åœ¨çº¿ç”¨æˆ·:</span>
            <div class="badge">
                <span id="online-count">-</span>
            </div>
        </div>
    </div>
    
    <div class="chat-container card-panel">
        <div id="chat"></div>
        <div class="typing-indicator" id="typing-indicator"></div>
    </div>
    
    <div class="input-area">
        <div class="emoji-container">
            <button class="emoji-button" id="emoji-button" title="é€‰æ‹©è¡¨æƒ…">ğŸ˜Š</button>
            <div class="emoji-panel" id="emoji-panel"></div>
        </div>
        
        <div class="media-upload">
            <button class="media-button" id="media-button" title="ä¸Šä¼ ç…§ç‰‡æˆ–è§†é¢‘">ğŸ“·</button>
            <input type="file" id="file-input" accept="image/*, video/*" style="display: none;" multiple>
        </div>
        
        <input type="text" id="input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeyup="updateTypingStatus()" onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="send-button" onclick="sendMessage()">
            <span class="send-icon">ğŸ“¨</span>
            <span class="send-text">å‘é€</span>
        </button>
    </div>
    
    <!-- åª’ä½“é¢„è§ˆåŒºåŸŸ -->
    <div class="media-preview-container" id="media-preview-container" style="display: none;">
        <div class="media-preview-header">
            <span>å¾…ä¸Šä¼ åª’ä½“æ–‡ä»¶</span>
            <button class="icon-button" id="clear-media" title="æ¸…é™¤æ‰€æœ‰åª’ä½“">âŒ</button>
        </div>
        <div class="media-preview-content" id="media-preview-content"></div>
    </div>
    
    <div class="sound-control">
        <button id="mute-button" class="icon-button" title="é™éŸ³é€šçŸ¥">
            ğŸ””
        </button>
    </div>
    
    <footer class="app-footer">
        <div class="footer-content">
            <p>åŸºäºFirebaseå®æ—¶æ•°æ®åº“ Â· çŒ«å’ªèŠå¤© Cat Talk</p>
        </div>
    </footer>
    
    <script type="module">
        // å¯¼å…¥Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            set, 
            onChildAdded, 
            onValue, 
            query, 
            limitToLast,
            onDisconnect,
            serverTimestamp,
            remove,
            get
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDkygULk8HZXnGpICuCVcyAztaz80efePk",
            authDomain: "cattalk-ade50.firebaseapp.com",
            databaseURL: "https://cattalk-ade50-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cattalk-ade50",
            storageBucket: "cattalk-ade50.firebasestorage.app",
            messagingSenderId: "210485142610",
            appId: "1:210485142610:web:de99542e92e93cde236b8b",
            measurementId: "G-8GL4789D12"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');
        const onlineRef = ref(db, 'online');
        const typingRef = ref(db, 'typing');
        
        // å­˜å‚¨å¾…ä¸Šä¼ çš„åª’ä½“æ–‡ä»¶
        let selectedMediaFiles = [];
        
        // éšæœºçŒ«å’ªåå­—åˆ—è¡¨
        const catNames = [
            "å’ªå’ª", "èŠ±èŠ±", "å°æ©˜", "é»‘è±†", "é›ªçƒ", 
            "èƒ–è™", "å¥¶èŒ¶", "çƒçƒ", "è±†è±†", "å°èŠ±",
            "æ¯›çº¿", "ç‚¹ç‚¹", "è™æ–‘", "æ˜Ÿæ˜Ÿ", "ç°ç°",
            "å°é»‘", "æ–‘æ–‘", "ç³–ç³–", "ç±³ç±³", "å°å¥¶",
            "å¯ä¹", "å·§å…‹åŠ›", "é¥¼å¹²", "å¤ªé˜³", "æœˆäº®",
            "ç‰ç±³", "ç‰›å¥¶", "è“è“", "é¦™è‰", "æ£‰èŠ±ç³–"
        ];
        
        // çŒ«å’ªè¡¨æƒ…åˆ—è¡¨
        const catEmojis = [
            "ğŸ±", "ğŸ˜º", "ğŸ˜¸", "ğŸ˜¹", "ğŸ˜»", "ğŸ˜¼", "ğŸ˜½", "ğŸ™€", "ğŸ˜¿", "ğŸ˜¾",
            "ğŸˆ", "ğŸˆâ€â¬›", "ğŸ¦", "ğŸ¯", "ğŸ…", "ğŸ†", "ğŸ¦‚", "ğŸ¦Š"
        ];
        
        // ç”Ÿæˆéšæœºåå­—
        function generateRandomName() {
            const randomPrefix = catNames[Math.floor(Math.random() * catNames.length)];
            return `${randomPrefix}çŒ«`;
        }
        
        // ä½¿ç”¨ç”¨æˆ·IDç”Ÿæˆå”¯ä¸€é¢œè‰²å’Œè¡¨æƒ…
        function generateRandomColor(seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                const adjustedValue = Math.max(Math.min(value, 220), 100);
                color += ('00' + adjustedValue.toString(16)).substr(-2);
            }
            
            return color;
        }
        
        function getRandomCatEmoji(userId) {
            // ä½¿ç”¨ç”¨æˆ·IDç”Ÿæˆå›ºå®šçš„è¡¨æƒ…ç´¢å¼•
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % catEmojis.length;
            return catEmojis[index];
        }
        
        // ç”Ÿæˆå¤´åƒHTML
        function getAvatarHTML(userId, nickname) {
            const color = generateRandomColor(userId);
            const emoji = getRandomCatEmoji(userId);
            
            return `
                <div class="avatar" style="background-color: ${color};">
                    <span class="cat-emoji">${emoji}</span>
                </div>
            `;
        }

        // ç”¨æˆ·æ ‡è¯†ç®¡ç†
        let userId = localStorage.getItem('firebase-chat-userId');
        if (!userId) {
            userId = Math.random().toString(36).substring(2, 8);
            localStorage.setItem('firebase-chat-userId', userId);
        }
        
        // è·å–æˆ–ç”Ÿæˆæ˜µç§°
        let nickname = localStorage.getItem('firebase-chat-nickname');
        if (!nickname) {
            nickname = generateRandomName();
            localStorage.setItem('firebase-chat-nickname', nickname);
        }
        
        // æ˜¾ç¤ºç”¨æˆ·IDå’Œæ˜µç§°
        document.getElementById('user-id').textContent = `${nickname} (${userId.substring(0, 4)})`;
        document.getElementById('nickname').value = nickname;
        
        // æ›´æ–°åœ¨çº¿çŠ¶æ€
        const myStatusRef = ref(db, `online/${userId}`);
        set(myStatusRef, {
            online: true,
            nickname: nickname,
            lastSeen: serverTimestamp()
        });
        
        // ç”¨æˆ·æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨æ›´æ–°çŠ¶æ€
        onDisconnect(myStatusRef).remove();
        
        // ç›‘å¬åœ¨çº¿ç”¨æˆ·æ•°é‡
        onValue(onlineRef, (snapshot) => {
            const data = snapshot.val() || {};
            const onlineUsers = Object.keys(data).length;
            document.getElementById('online-count').textContent = onlineUsers;
        });

        // ç›‘å¬æ–°æ¶ˆæ¯
        const recentMessagesQuery = query(messagesRef, limitToLast(50));
        onChildAdded(recentMessagesQuery, (snapshot) => {
            const msg = snapshot.val();
            addMessageToChat(msg, snapshot.key);
            
            // å¦‚æœæ¶ˆæ¯ä¸æ˜¯è‡ªå·±å‘çš„ï¼Œæ’­æ”¾æç¤ºéŸ³
            if (msg.userId !== userId) {
                playNotificationSound();
            }
        });

        // ç›‘å¬è¾“å…¥çŠ¶æ€
        onValue(typingRef, (snapshot) => {
            const typingUsers = snapshot.val() || {};
            const typingUserIds = Object.keys(typingUsers).filter(id => id !== userId && typingUsers[id].typing);
            const typingIndicator = document.getElementById('typing-indicator');
            
            if (typingUserIds.length > 0) {
                const names = typingUserIds.map(id => {
                    return typingUsers[id].nickname || `ç”¨æˆ·${id.substring(0, 4)}`;
                });
                
                if (names.length === 1) {
                    typingIndicator.textContent = `${names[0]} æ­£åœ¨è¾“å…¥...`;
                } else if (names.length === 2) {
                    typingIndicator.textContent = `${names[0]} å’Œ ${names[1]} æ­£åœ¨è¾“å…¥...`;
                } else {
                    typingIndicator.textContent = `${names.length} ä¸ªç”¨æˆ·æ­£åœ¨è¾“å…¥...`;
                }
            } else {
                typingIndicator.textContent = '';
            }
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œæ›´æ–°åœ¨çº¿çŠ¶æ€
                set(myStatusRef, {
                    online: true,
                    nickname: nickname,
                    lastSeen: serverTimestamp()
                });
            }
        });

        // å‘é€æ¶ˆæ¯å‡½æ•°
        window.sendMessage = async function() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            
            // å¦‚æœæ—¢æ²¡æœ‰æ–‡æœ¬æ¶ˆæ¯ä¹Ÿæ²¡æœ‰åª’ä½“æ–‡ä»¶ï¼Œåˆ™ä¸å‘é€
            if (!text && selectedMediaFiles.length === 0) return;
            
            try {
                // ä¸Šä¼ åª’ä½“æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
                let mediaData = {urls: [], types: []};
                if (selectedMediaFiles.length > 0) {
                    mediaData = await uploadMediaFiles();
                }
                
                // å‘é€æ¶ˆæ¯
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, {
                    text: text,
                    userId: userId,
                    nickname: nickname,
                    timestamp: Date.now(),
                    mediaUrls: mediaData.urls,
                    mediaTypes: mediaData.types
                });
                
                // æ¸…ç©ºè¾“å…¥
                input.value = '';
                
                // æ¸…é™¤æ­£åœ¨è¾“å…¥çŠ¶æ€
                const typingUserRef = ref(db, `typing/${userId}`);
                set(typingUserRef, { typing: false, nickname: nickname });
            } catch (error) {
                console.error("å‘é€æ¶ˆæ¯æ—¶å‡ºé”™:", error);
                showNotification("å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        };
        
        // è®¾ç½®æ˜µç§°
        window.setNickname = function() {
            const nicknameInput = document.getElementById('nickname');
            const newNickname = nicknameInput.value.trim();
            
            if (newNickname) {
                nickname = newNickname;
                localStorage.setItem('firebase-chat-nickname', nickname);
                document.getElementById('user-id').textContent = `${nickname} (${userId.substring(0, 4)})`;
                
                // æ›´æ–°åœ¨çº¿çŠ¶æ€ä¸­çš„æ˜µç§°
                set(myStatusRef, {
                    online: true,
                    nickname: nickname,
                    lastSeen: serverTimestamp()
                });
                
                alert(`æ˜µç§°å·²æ›´æ–°ä¸º: ${nickname}`);
            }
        };
        
        // æ›´æ–°æ­£åœ¨è¾“å…¥çŠ¶æ€
        let typingTimeout;
        window.updateTypingStatus = function() {
            const typingUserRef = ref(db, `typing/${userId}`);
            set(typingUserRef, { typing: true, nickname: nickname });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(typingUserRef, { typing: false, nickname: nickname });
            }, 3000);
        };

        // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
        function addMessageToChat(message, messageId) {
            if (!message) return;
            
            const isOwnMessage = message.userId === userId;
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwnMessage ? 'own-message' : ''} clearfix`;
            messageElement.id = `msg-${messageId}`;
            
            // æ ¼å¼åŒ–æ—¶é—´
            const messageDate = new Date(message.timestamp);
            const timeString = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = messageDate.toLocaleDateString();
            
            // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œæ›¿æ¢è¡¨æƒ…
            const hasText = message.text && message.text.trim() !== '';
            const processedText = hasText ? replaceEmojisInText(escapeHtml(message.text)) : '';
            
            // ç”Ÿæˆç”¨æˆ·ä¿¡æ¯HTML
            let messageHTML = `
                <div class="user-info">
                    ${getAvatarHTML(message.userId, message.nickname)}
                    <div class="message-meta">
                        <div class="message-header">
                            <span class="message-sender">${escapeHtml(message.nickname || 'åŒ¿åçŒ«å’ª')}</span>
                            <span class="message-time">${timeString}</span>
                        </div>
                    </div>
                </div>
                <div class="message-content">
            `;
            
            // æ·»åŠ æ–‡æœ¬å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (hasText) {
                messageHTML += `<div class="message-text">${processedText}</div>`;
            }
            
            // æ·»åŠ åª’ä½“å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (message.mediaUrls && message.mediaUrls.length > 0) {
                message.mediaUrls.forEach((url, index) => {
                    const mediaType = message.mediaTypes && message.mediaTypes[index] ? message.mediaTypes[index] : detectMediaType(url);
                    
                    if (mediaType === 'image') {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯Base64ç¼–ç çš„å›¾ç‰‡
                        if (url.startsWith('data:image/')) {
                            messageHTML += `
                                <div class="message-media">
                                    <img src="${url}" alt="å›¾ç‰‡" loading="lazy" onclick="showFullscreenMedia('${url}', 'image')">
                                </div>
                            `;
                        } else {
                            // è¿œç¨‹å›¾ç‰‡URL
                            messageHTML += `
                                <div class="message-media">
                                    <img src="${url}" alt="å›¾ç‰‡" loading="lazy" onclick="showFullscreenMedia('${url}', 'image')">
                                </div>
                            `;
                        }
                    } else if (mediaType === 'video') {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯Base64ç¼–ç çš„è§†é¢‘
                        if (url.startsWith('data:video/')) {
                            messageHTML += `
                                <div class="message-media">
                                    <video src="${url}" controls preload="metadata"></video>
                                </div>
                            `;
                        } else {
                            // è¿œç¨‹è§†é¢‘URL
                            messageHTML += `
                                <div class="message-media">
                                    <video src="${url}" controls preload="metadata"></video>
                                </div>
                            `;
                        }
                    }
                });
            }
            
            // æ·»åŠ æ¶ˆæ¯æ—¶é—´æˆ³
            messageHTML += `<div class="message-footer">${dateString}</div></div>`;
            
            // è®¾ç½®æ¶ˆæ¯å†…å®¹
            messageElement.innerHTML = messageHTML;
            
            // æ·»åŠ åˆ°èŠå¤©åŒºåŸŸå¹¶æ»šåŠ¨åˆ°åº•éƒ¨
            const chatElement = document.getElementById('chat');
            chatElement.appendChild(messageElement);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä½†ä»…å½“ç”¨æˆ·åœ¨åº•éƒ¨æˆ–è€…æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯æ—¶
            const isNearBottom = chatElement.scrollHeight - chatElement.scrollTop - chatElement.clientHeight < 150;
            if (isNearBottom || isOwnMessage) {
                chatElement.scrollTop = chatElement.scrollHeight;
            }
            
            // å¦‚æœä¸æ˜¯è‡ªå·±çš„æ¶ˆæ¯ä¸”é¡µé¢ä¸å¯è§ï¼Œæ’­æ”¾æç¤ºéŸ³
            if (!isOwnMessage && document.hidden) {
                playNotificationSound();
            }
        }
        
        // æ ¹æ®URLæ£€æµ‹åª’ä½“ç±»å‹
        function detectMediaType(url) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯Base64ç¼–ç çš„å›¾ç‰‡æˆ–è§†é¢‘
            if (url.startsWith('data:image/')) return 'image';
            if (url.startsWith('data:video/')) return 'video';
            
            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼ˆç”¨äºURLï¼‰
            const ext = url.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'];
            const videoExts = ['mp4', 'webm', 'ogg', 'mov'];
            
            if (imageExts.includes(ext)) return 'image';
            if (videoExts.includes(ext)) return 'video';
            
            // å¦‚æœæ— æ³•ä»æ‰©å±•ååˆ¤æ–­ï¼Œåˆ™ä»URLä¸­æŸ¥æ‰¾æ ‡è¯†å­—ç¬¦ä¸²
            if (url.includes('image') || url.includes('img')) return 'image';
            if (url.includes('video') || url.includes('mp4')) return 'video';
            
            // é»˜è®¤è¿”å›å›¾ç‰‡ç±»å‹
            return 'image';
        }
        
        // æ›¿æ¢æ–‡æœ¬ä¸­çš„è¡¨æƒ…ç¬¦å·ä¸ºè¡¨æƒ…å›¾åƒ
        function replaceEmojisInText(text) {
            // ç®€å•æ›¿æ¢å¸¸è§è¡¨æƒ…ç¬¦å·
            return text.replace(/:\)/g, 'ğŸ˜Š')
                       .replace(/:\(/g, 'ğŸ˜')
                       .replace(/:\D/g, 'ğŸ˜ƒ')
                       .replace(/;\)/g, 'ğŸ˜‰')
                       .replace(/:P/g, 'ğŸ˜‹')
                       .replace(/:O/g, 'ğŸ˜²')
                       .replace(/:'\(/g, 'ğŸ˜¢');
        }
        
        // æ˜¾ç¤ºå…¨å±åª’ä½“
        window.showFullscreenMedia = function(url, type) {
            // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿URLæœ‰æ•ˆ
            if (!url) {
                console.error("æ— æ•ˆçš„åª’ä½“URL");
                return;
            }
            
            // è·å–æˆ–åˆ›å»ºå…¨å±æŸ¥çœ‹å™¨
            let fullscreenViewer = document.getElementById('media-fullscreen');
            if (!fullscreenViewer) {
                createMediaFullscreenViewer();
                fullscreenViewer = document.getElementById('media-fullscreen');
            }
            
            // è·å–å…³é—­æŒ‰é’®
            let closeButton = fullscreenViewer.querySelector('.close-fullscreen');
            if (!closeButton) {
                closeButton = document.createElement('button');
                closeButton.className = 'close-fullscreen';
                closeButton.innerHTML = 'Ã—';
                closeButton.onclick = () => {
                    fullscreenViewer.classList.remove('active');
                };
                fullscreenViewer.appendChild(closeButton);
            }
            
            // æ¸…é™¤æ—§å†…å®¹ï¼Œä¿ç•™å…³é—­æŒ‰é’®
            const buttons = fullscreenViewer.innerHTML;
            fullscreenViewer.innerHTML = '';
            fullscreenViewer.innerHTML = buttons;
            
            // åˆ›å»ºåª’ä½“å…ƒç´ 
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                img.alt = "å…¨å±å›¾ç‰‡";
                fullscreenViewer.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.autoplay = true;
                fullscreenViewer.appendChild(video);
            }
            
            // æ˜¾ç¤ºå…¨å±æŸ¥çœ‹å™¨
            fullscreenViewer.classList.add('active');
            
            // æ·»åŠ Escapeé”®å…³é—­åŠŸèƒ½
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    fullscreenViewer.classList.remove('active');
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        };
        
        // è¡¨æƒ…é€‰æ‹©å™¨åˆå§‹åŒ–
        function initEmojiSelector() {
            const emojiPanel = document.getElementById('emoji-panel');
            const emojiButton = document.getElementById('emoji-button');
            const input = document.getElementById('input');
            
            // å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
            const emojis = [
                'ğŸ˜Š', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ˜‰', 
                'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤ª', 'ğŸ¤¨',
                'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ',
                'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­',
                'ğŸ’ª', 'ğŸ‘', 'ğŸ‘', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘‹', 'ğŸ™', 'â¤ï¸'
            ];
            
            // ç”Ÿæˆè¡¨æƒ…é¢æ¿å†…å®¹
            emojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji;
                emojiSpan.className = 'emoji-item';
                emojiSpan.addEventListener('click', () => {
                    input.value += emoji;
                    emojiPanel.classList.remove('active');
                    input.focus();
                });
                emojiPanel.appendChild(emojiSpan);
            });
            
            // è¡¨æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            emojiButton.addEventListener('click', (event) => {
                emojiPanel.classList.toggle('active');
                event.stopPropagation();
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é¢æ¿
            document.addEventListener('click', (event) => {
                if (!event.target.matches('#emoji-button, #emoji-panel, #emoji-panel *')) {
                    emojiPanel.classList.remove('active');
                }
            });
        }
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ - ä¿®å¤IDå¼•ç”¨é”™è¯¯
        function initThemeSwitcher() {
            const themeSwitch = document.getElementById('theme-switch');
            const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸»é¢˜è®¾ç½®
            let currentTheme = localStorage.getItem('theme');
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨ç³»ç»Ÿåå¥½
            if (!currentTheme) {
                currentTheme = prefersDarkMode ? 'dark' : 'light';
                localStorage.setItem('theme', currentTheme);
            }
            
            // åº”ç”¨ä¸»é¢˜
            document.documentElement.dataset.theme = currentTheme;
            updateThemeIcon(currentTheme);
            
            // æ·»åŠ åˆ‡æ¢äº‹ä»¶
            themeSwitch.addEventListener('click', () => {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.dataset.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                currentTheme = newTheme;
                
                // æ›´æ–°å›¾æ ‡
                updateThemeIcon(newTheme);
                
                // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
                document.documentElement.classList.add('theme-transition');
                setTimeout(() => {
                    document.documentElement.classList.remove('theme-transition');
                }, 500);
            });
            
            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('theme')) {
                        const newTheme = e.matches ? 'dark' : 'light';
                        document.documentElement.dataset.theme = newTheme;
                        currentTheme = newTheme;
                        updateThemeIcon(newTheme);
                    }
                });
            }
        }
        
        function updateThemeIcon(theme) {
            const themeSwitch = document.getElementById('theme-switch');
            themeSwitch.innerHTML = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            themeSwitch.title = theme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
        }
        
        // åˆå§‹åŒ–é€šçŸ¥å£°éŸ³
        function initNotificationSound() {
            // ä½¿ç”¨ä¸€ä¸ªç®€çŸ­æ¸…è„†çš„æç¤ºéŸ³
            const notificationSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAACAAADrAAICAgICAgICAgICAgQEBAQEBAQEBAQEBAgICAgICAgICAgICAoKCgoKCgoKCgoKDA//Dw8PDw8PDw8PDw8P/////////////////////8AAAA//MUZAAAAAGkAAAAAAAAA0gAAAAATEFNRTMuMTAw//NUZC8AAAGkAAAAAAAAAUQAAAAATZV//NUZDUAAAGkAAAAAAAAAUgAAAAA4OS45//NUZEIAAAGBAAAAAAAAAUQAAAAALD//NUZDmAAAGkAAAAAAAAAUgAAAAAyLjE//NUZEAAAAGRAAAAAAAAAUAAAAABA");
            
            // è®¾ç½®é™éŸ³æŒ‰é’®
            const muteButton = document.getElementById('mute-button');
            const isMuted = localStorage.getItem('isMuted') === 'true';
            
            // åº”ç”¨ä¿å­˜çš„é™éŸ³çŠ¶æ€
            notificationSound.muted = isMuted;
            updateMuteButtonIcon(isMuted);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            muteButton.addEventListener('click', () => {
                const newMutedState = !notificationSound.muted;
                notificationSound.muted = newMutedState;
                localStorage.setItem('isMuted', newMutedState);
                
                // æ›´æ–°å›¾æ ‡å’Œå·¥å…·æç¤º
                updateMuteButtonIcon(newMutedState);
                
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showNotification(newMutedState ? 'å·²å…³é—­é€šçŸ¥å£°éŸ³' : 'å·²å¼€å¯é€šçŸ¥å£°éŸ³');
            });
            
            // æä¾›æ’­æ”¾å£°éŸ³çš„å‡½æ•°
            window.playNotificationSound = function() {
                if (!notificationSound.muted && document.hidden) {
                    // é‡ç½®å£°éŸ³è¿›åº¦å¹¶æ’­æ”¾
                    notificationSound.currentTime = 0;
                    notificationSound.play()
                        .catch(error => console.log('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error));
                }
            };
            
            // æµ‹è¯•å£°éŸ³æŒ‰é’®
            const testSoundButton = document.createElement('button');
            testSoundButton.className = 'icon-button';
            testSoundButton.innerHTML = 'ğŸ”Š';
            testSoundButton.title = 'æµ‹è¯•é€šçŸ¥å£°éŸ³';
            testSoundButton.onclick = function() {
                if (!notificationSound.muted) {
                    notificationSound.currentTime = 0;
                    notificationSound.play()
                        .then(() => showNotification('é€šçŸ¥å£°éŸ³æµ‹è¯•'))
                        .catch(error => showNotification('æ— æ³•æ’­æ”¾å£°éŸ³ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®'));
                } else {
                    showNotification('è¯·å…ˆå–æ¶ˆé™éŸ³');
                }
            };
            
            // æ·»åŠ æµ‹è¯•æŒ‰é’®åˆ°å£°éŸ³æ§åˆ¶åŒº
            document.querySelector('.sound-control').appendChild(testSoundButton);
        }
        
        // æ›´æ–°é™éŸ³æŒ‰é’®å›¾æ ‡
        function updateMuteButtonIcon(isMuted) {
            const muteButton = document.getElementById('mute-button');
            muteButton.innerHTML = isMuted ? 'ğŸ”•' : 'ğŸ””';
            muteButton.title = isMuted ? 'å¼€å¯é€šçŸ¥å£°éŸ³' : 'å…³é—­é€šçŸ¥å£°éŸ³';
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æç¤º
        function showNotification(message, type = 'default') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // æ ¹æ®ç±»å‹æ·»åŠ æ ·å¼
            if (type === 'warning') {
                notification.style.backgroundColor = 'var(--warning-color)';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'var(--error-color)';
            } else if (type === 'success') {
                notification.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'info') {
                notification.style.backgroundColor = 'var(--info-color)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // æ·¡å…¥æ•ˆæœ
            setTimeout(() => notification.classList.add('show'), 10);
            
            // 3ç§’åæ·¡å‡º
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åŠŸèƒ½
        window.addEventListener('DOMContentLoaded', () => {
            initEmojiSelector();
            initThemeSwitcher();
            initNotificationSound();
            initMediaUpload();
            
            // æ·»åŠ æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®åŠŸèƒ½
            const chatContainer = document.querySelector('.chat-container');
            const chat = document.getElementById('chat');
            
            if (chatContainer && chat) {
                const scrollIndicator = document.createElement('div');
                scrollIndicator.className = 'scroll-indicator';
                scrollIndicator.innerHTML = 'â¬‡ï¸';
                scrollIndicator.title = 'æ»šåŠ¨åˆ°åº•éƒ¨';
                chatContainer.appendChild(scrollIndicator);
                
                // ç›‘å¬æ»šåŠ¨äº‹ä»¶
                chat.addEventListener('scroll', () => {
                    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
                    if (!isNearBottom && chat.scrollHeight > chat.clientHeight) {
                        scrollIndicator.classList.add('visible');
                    } else {
                        scrollIndicator.classList.remove('visible');
                    }
                });
                
                // ç‚¹å‡»æ»šåŠ¨åˆ°åº•éƒ¨
                scrollIndicator.addEventListener('click', () => {
                    chat.scrollTop = chat.scrollHeight;
                });
            }
            
            // åˆ›å»ºå…¨å±åª’ä½“é¢„è§ˆå®¹å™¨
            createMediaFullscreenViewer();
        });
        
        // åˆ›å»ºå…¨å±åª’ä½“é¢„è§ˆå®¹å™¨
        function createMediaFullscreenViewer() {
            const fullscreenViewer = document.createElement('div');
            fullscreenViewer.className = 'media-fullscreen';
            fullscreenViewer.id = 'media-fullscreen';
            
            const closeButton = document.createElement('button');
            closeButton.className = 'close-fullscreen';
            closeButton.innerHTML = 'Ã—';
            closeButton.onclick = () => {
                fullscreenViewer.classList.remove('active');
                fullscreenViewer.innerHTML = '';
                fullscreenViewer.appendChild(closeButton);
            };
            
            fullscreenViewer.appendChild(closeButton);
            document.body.appendChild(fullscreenViewer);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­é¢„è§ˆ
            fullscreenViewer.addEventListener('click', (e) => {
                if (e.target === fullscreenViewer) {
                    fullscreenViewer.classList.remove('active');
                    fullscreenViewer.innerHTML = '';
                    fullscreenViewer.appendChild(closeButton);
                }
            });
        }
        
        // åˆå§‹åŒ–åª’ä½“ä¸Šä¼ åŠŸèƒ½
        function initMediaUpload() {
            const mediaButton = document.getElementById('media-button');
            const fileInput = document.getElementById('file-input');
            const mediaPreviewContainer = document.getElementById('media-preview-container');
            const mediaPreviewContent = document.getElementById('media-preview-content');
            const clearMediaButton = document.getElementById('clear-media');
            
            // ç‚¹å‡»åª’ä½“æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
            mediaButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            // åª’ä½“æŒ‰é’®å·¥å…·æç¤º
            mediaButton.title = "ä¸Šä¼ ç…§ç‰‡æˆ–è§†é¢‘ (å›¾ç‰‡ä¸é™å¤§å°ï¼Œè§†é¢‘<3MB)";
            
            // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                // æ˜¾ç¤ºæ–‡ä»¶å¤„ç†ä¸­æç¤º
                if (files.length > 3) {
                    showNotification(`æ­£åœ¨å¤„ç† ${files.length} ä¸ªæ–‡ä»¶ï¼Œè¯·ç¨å€™...`);
                }
                
                // å°†é€‰æ‹©çš„æ–‡ä»¶æ·»åŠ åˆ°å¾…ä¸Šä¼ åˆ—è¡¨
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileType = file.type.split('/')[0]; // 'image' or 'video'
                    
                    if (fileType === 'video') {
                        // è§†é¢‘å¤§å°é™åˆ¶ (3MB)
                        if (file.size > 3 * 1024 * 1024) {
                            showNotification(`è§†é¢‘ ${file.name} è¿‡å¤§ï¼Œé™åˆ¶3MBä»¥å†…`, 'warning');
                            continue;
                        }
                    } else if (fileType === 'image') {
                        // å›¾ç‰‡ä¼šè¢«è‡ªåŠ¨å‹ç¼©ï¼Œæ— éœ€é™åˆ¶å¤§å°
                        // ä½†å¤ªå¤§çš„æ–‡ä»¶ä¼šå½±å“æ€§èƒ½ï¼Œæ˜¾ç¤ºè­¦å‘Š
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification(`å›¾ç‰‡ ${file.name} è¾ƒå¤§ï¼Œå°†è¢«å‹ç¼©å¤„ç†`, 'info');
                        }
                    } else {
                        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                        showNotification(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.type}`, 'warning');
                        continue;
                    }
                    
                    // æ·»åŠ åˆ°å¾…å¤„ç†åˆ—è¡¨
                    selectedMediaFiles.push({
                        file: file,
                        id: Math.random().toString(36).substring(2, 10),
                        type: fileType
                    });
                }
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
                fileInput.value = '';
                
                // æ›´æ–°é¢„è§ˆ
                updateMediaPreview();
            });
            
            // æ¸…é™¤æ‰€æœ‰å¾…ä¸Šä¼ åª’ä½“
            clearMediaButton.addEventListener('click', () => {
                selectedMediaFiles = [];
                updateMediaPreview();
                showNotification('å·²æ¸…é™¤æ‰€æœ‰å¾…ä¸Šä¼ åª’ä½“');
            });
            
            // æ›´æ–°åª’ä½“é¢„è§ˆ
            function updateMediaPreview() {
                mediaPreviewContent.innerHTML = '';
                
                if (selectedMediaFiles.length === 0) {
                    mediaPreviewContainer.style.display = 'none';
                    return;
                }
                
                mediaPreviewContainer.style.display = 'block';
                
                // æ›´æ–°é¢„è§ˆæ ‡é¢˜
                const previewHeader = mediaPreviewContainer.querySelector('.media-preview-header span');
                if (previewHeader) {
                    previewHeader.textContent = `å¾…å‘é€åª’ä½“æ–‡ä»¶ (${selectedMediaFiles.length})`;
                }
                
                selectedMediaFiles.forEach((mediaItem) => {
                    const file = mediaItem.file;
                    const mediaId = mediaItem.id;
                    const fileType = mediaItem.type;
                    
                    const mediaItemElement = document.createElement('div');
                    mediaItemElement.className = 'media-item';
                    mediaItemElement.dataset.id = mediaId;
                    
                    // åˆ›å»ºé¢„è§ˆå…ƒç´ 
                    if (fileType === 'image') {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        mediaItemElement.appendChild(img);
                    } else if (fileType === 'video') {
                        const video = document.createElement('video');
                        video.src = URL.createObjectURL(file);
                        video.muted = true; // è‡ªåŠ¨æ’­æ”¾éœ€è¦é™éŸ³
                        video.controls = true;
                        mediaItemElement.appendChild(video);
                    }
                    
                    // æ·»åŠ æ–‡ä»¶ä¿¡æ¯
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'file-info';
                    fileInfo.textContent = formatFileSize(file.size);
                    mediaItemElement.appendChild(fileInfo);
                    
                    // æ·»åŠ åˆ é™¤æŒ‰é’®
                    const removeButton = document.createElement('button');
                    removeButton.className = 'remove-media';
                    removeButton.innerHTML = 'Ã—';
                    removeButton.addEventListener('click', () => {
                        selectedMediaFiles = selectedMediaFiles.filter(item => item.id !== mediaId);
                        updateMediaPreview();
                    });
                    
                    mediaItemElement.appendChild(removeButton);
                    mediaPreviewContent.appendChild(mediaItemElement);
                });
            }
            
            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
        }
        
        // ä¸Šä¼ æ‰€æœ‰é€‰å®šçš„åª’ä½“æ–‡ä»¶ï¼Œå¹¶è¿”å›Base64ç¼–ç åçš„æ•°æ®
        async function uploadMediaFiles() {
            if (selectedMediaFiles.length === 0) return {urls: [], types: []};
            
            const mediaData = [];
            const mediaTypes = [];
            const maxSizeForBase64 = 1 * 1024 * 1024; // 1MBé™åˆ¶
            
            showNotification(`æ­£åœ¨å¤„ç† ${selectedMediaFiles.length} ä¸ªåª’ä½“æ–‡ä»¶ï¼Œè¯·ç¨å€™...`);
            
            // åˆ›å»ºå¤„ç†è¿›åº¦æŒ‡ç¤ºå™¨
            const progressElement = document.createElement('div');
            progressElement.className = 'upload-progress';
            const progressBar = document.createElement('div');
            progressBar.className = 'upload-progress-bar';
            progressElement.appendChild(progressBar);
            document.querySelector('.media-preview-container').appendChild(progressElement);
            
            try {
                for (let i = 0; i < selectedMediaFiles.length; i++) {
                    const mediaItem = selectedMediaFiles[i];
                    const file = mediaItem.file;
                    const fileType = file.type.split('/')[0]; // 'image' or 'video'
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    progressBar.style.width = ((i / selectedMediaFiles.length) * 100) + '%';
                    
                    // å¯¹äºå›¾ç‰‡ï¼Œè½¬æ¢ä¸ºBase64
                    if (fileType === 'image') {
                        // æ£€æŸ¥æ–‡ä»¶å¤§å°
                        if (file.size > maxSizeForBase64) {
                            showNotification(`å›¾ç‰‡ ${file.name} è¿‡å¤§ï¼Œè¿›è¡Œå‹ç¼©å¤„ç†...`);
                            // åœ¨æ·»åŠ åˆ°åˆ—è¡¨å‰æ‰§è¡Œå‹ç¼©
                            const compressedBase64 = await compressImage(file, 0.8, 800);
                            mediaData.push(compressedBase64);
                        } else {
                            // å°æ–‡ä»¶ç›´æ¥è½¬æ¢ä¸ºBase64
                            const base64 = await readFileAsBase64(file);
                            mediaData.push(base64);
                        }
                        mediaTypes.push('image');
                    } else if (fileType === 'video') {
                        // è§†é¢‘ä»ç„¶ä½¿ç”¨åŸä¸Šä¼ æ–¹å¼ï¼Œä½†ä»…ç”¨äºå°è§†é¢‘
                        if (file.size > maxSizeForBase64 * 3) {
                            showNotification(`è§†é¢‘ ${file.name} è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº3MBçš„è§†é¢‘`);
                            continue;
                        }
                        
                        // å°è§†é¢‘è½¬æ¢ä¸ºBase64
                        const base64 = await readFileAsBase64(file);
                        mediaData.push(base64);
                        mediaTypes.push('video');
                    }
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    progressBar.style.width = (((i + 1) / selectedMediaFiles.length) * 100) + '%';
                }
                
                // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
                showNotification(`${mediaData.length} ä¸ªåª’ä½“æ–‡ä»¶å¤„ç†æˆåŠŸ`);
                
                // æ¸…ç©ºå¾…ä¸Šä¼ åˆ—è¡¨
                selectedMediaFiles = [];
                document.getElementById('media-preview-container').style.display = 'none';
                
                // è¿”å›åª’ä½“æ•°æ®å’Œç±»å‹
                return {urls: mediaData, types: mediaTypes};
                
            } catch (error) {
                console.error("åª’ä½“å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:", error);
                showNotification("åª’ä½“å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•");
                return {urls: [], types: []};
            } finally {
                // ç§»é™¤è¿›åº¦æ¡
                if (progressElement.parentNode) {
                    progressElement.parentNode.removeChild(progressElement);
                }
            }
        }
        
        // è¯»å–æ–‡ä»¶ä¸ºBase64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // å‹ç¼©å›¾ç‰‡
        function compressImage(file, quality = 0.8, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        // è®¡ç®—æ–°çš„å®½é«˜
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        // ä½¿ç”¨Canvaså‹ç¼©
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è½¬æ¢ä¸ºBase64
                        const dataUrl = canvas.toDataURL(file.type, quality);
                        resolve(dataUrl);
                    };
                    img.onerror = function(error) {
                        reject(error);
                    };
                    img.src = event.target.result;
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html> 