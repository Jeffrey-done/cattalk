<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猫咪聊天 | Cat Talk</title>
    <script>
        // 在CSS加载前应用保存的主题，避免闪烁
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme) {
                document.documentElement.dataset.theme = savedTheme;
            } else if (prefersDarkMode) {
                document.documentElement.dataset.theme = 'dark';
                localStorage.setItem('theme', 'dark');
            }
        })();
    </script>
    <style>
        :root {
            /* 主色调 - 新设计系统 */
            --primary-color: #3A4A8C; /* 深海蓝紫色 - 主色 */
            --primary-light: #4F62B3; /* 主色调亮色变体 */
            --primary-dark: #293667; /* 主色调暗色变体 */
            --accent-color: #FF7A6B; /* 珊瑚粉 - 点缀色 */
            --accent-light: #FF9D93; /* 点缀色亮色变体 */
            --accent-dark: #E05E4F; /* 点缀色暗色变体 */
            --tertiary-color: #80CEB8; /* 薄荷绿 - 辅助色 */
            
            /* 中性色 */
            --neutral-100: #F2F5FF; /* 珍珠白 */
            --neutral-200: #DFE3F2; /* 淡蓝灰 */
            --neutral-300: #C2C8DC; /* 浅蓝灰 */
            --neutral-400: #9BA2BC; /* 中蓝灰 */
            --neutral-500: #737A97; /* 灰蓝 */
            --neutral-600: #5A6178; /* 深灰蓝 */
            --neutral-700: #404455; /* 暗灰蓝 */
            --neutral-800: #272936; /* 深墨蓝 */
            --neutral-900: #121A34; /* 深邃靛蓝 */
            
            /* 语义色 */
            --info-color: #4F62B3; /* 信息色 - 基于主色 */
            --success-color: #80CEB8; /* 成功色 - 基于辅助色 */
            --warning-color: #FFB26B; /* 警告色 - 温暖橙色 */
            --error-color: #FF7A6B; /* 错误色 - 基于点缀色 */
            
            /* 亮色模式下的变量 */
            --bg-color: var(--neutral-100);
            --bg-gradient: linear-gradient(145deg, var(--neutral-100), var(--neutral-200));
            --text-color: var(--neutral-800);
            --chat-bg: rgba(255, 255, 255, 0.85);
            --chat-blur: blur(12px);
            --border-color: var(--neutral-200);
            --msg-bg: rgba(var(--neutral-200-rgb), 0.7);
            --own-msg-bg: rgba(var(--primary-light-rgb), 0.7);
            --input-bg: rgba(255, 255, 255, 0.9);
            --button-bg: var(--primary-color);
            --button-hover: var(--primary-dark);
            --shadow-color: rgba(0,0,0,0.08);
            --shadow-hover: rgba(0,0,0,0.15);
            --primary-color-rgb: 79, 98, 179;
            --neutral-200-rgb: 223, 227, 242;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-blur: blur(10px);
            --card-border: 1px solid rgba(255, 255, 255, 0.4);
            --card-radius: 16px;
            --msg-radius-sender: 18px 18px 18px 4px;
            --msg-radius-own: 18px 18px 4px 18px;
            --btn-radius: 22px;
            --transition-normal: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        [data-theme="dark"] {
            /* 暗色模式下的变量 */
            --bg-color: var(--neutral-900);
            --bg-gradient: linear-gradient(145deg, var(--neutral-900), var(--neutral-800));
            --text-color: var(--neutral-200);
            --chat-bg: rgba(39, 41, 54, 0.8);
            --border-color: var(--neutral-700);
            --msg-bg: rgba(64, 68, 85, 0.7);
            --own-msg-bg: rgba(41, 54, 103, 0.7);
            --input-bg: rgba(64, 68, 85, 0.8);
            --button-bg: var(--primary-dark);
            --button-hover: var(--primary-color);
            --shadow-color: rgba(0,0,0,0.2);
            --shadow-hover: rgba(0,0,0,0.4);
            --primary-color-rgb: 41, 54, 103;
            --neutral-700-rgb: 64, 68, 85;
            --card-bg: rgba(39, 41, 54, 0.75);
            --card-border: 1px solid rgba(79, 98, 179, 0.2);
        }
        
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 添加背景图案 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M30,10 Q35,0 40,10 T50,10 T60,10 T70,10" fill="none" stroke-width="0.5" stroke="rgba(130,150,200,0.15)" /></svg>');
            background-size: 100px 100px;
            opacity: 0.5;
            pointer-events: none;
            z-index: -1;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
            letter-spacing: -0.5px;
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 40%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            border-radius: 3px;
        }
        
        #chat {
            height: 450px;
            overflow-y: auto;
            border: var(--card-border);
            padding: 15px;
            background-color: var(--chat-bg);
            backdrop-filter: var(--chat-blur);
            -webkit-backdrop-filter: var(--chat-blur);
            border-radius: var(--card-radius);
            margin-bottom: 15px;
            box-shadow: 0 8px 24px var(--shadow-color);
            transition: var(--transition-normal);
            scrollbar-width: thin;
            scrollbar-color: var(--neutral-400) transparent;
        }
        
        #chat::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat::-webkit-scrollbar-thumb {
            background-color: var(--neutral-400);
            border-radius: 3px;
        }
        
        #chat::-webkit-scrollbar-track {
            background-color: transparent;
        }
        
        .message {
            margin: 10px 0;
            padding: 12px 16px;
            background: var(--msg-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: var(--msg-radius-sender);
            max-width: 80%;
            word-break: break-word;
            position: relative;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 10px var(--shadow-color);
            clear: both;
            float: left;
            transition: var(--transition-normal);
            border: 1px solid rgba(var(--neutral-300-rgb, 194, 200, 220), 0.2);
        }
        
        .message:hover {
            box-shadow: 0 4px 15px var(--shadow-hover);
            transform: translateY(-2px);
        }
        
        .message.own-message {
            background: var(--own-msg-bg);
            border-radius: var(--msg-radius-own);
            float: right;
            text-align: right;
            border: 1px solid rgba(var(--primary-color-rgb), 0.2);
        }
        
        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.7);
        }
        
        .avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        .message.own-message .avatar {
            margin-right: 0;
            margin-left: 12px;
        }
        
        .cat-emoji {
            font-size: 24px;
            line-height: 1;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }
        
        .avatar:hover .cat-emoji {
            transform: rotate(15deg);
        }
        
        .input-area {
            display: flex;
            gap: 12px;
            position: relative;
            margin-top: 15px;
            background-color: var(--card-bg);
            backdrop-filter: var(--card-blur);
            -webkit-backdrop-filter: var(--card-blur);
            padding: 12px;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 20px var(--shadow-color);
            transition: var(--transition-normal);
            border: var(--card-border);
        }
        
        .input-area:focus-within {
            box-shadow: 0 8px 32px var(--shadow-color);
            transform: translateY(-2px);
        }
        
        #input {
            flex-grow: 1;
            padding: 12px 16px;
            border: 1px solid rgba(var(--neutral-300-rgb, 194, 200, 220), 0.4);
            border-radius: var(--btn-radius);
            font-size: 0.95rem;
            outline: none;
            transition: var(--transition-normal);
            background-color: var(--input-bg);
            color: var(--text-color);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        #input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.15);
        }
        
        button {
            padding: 0 20px;
            height: 44px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: var(--btn-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s ease;
        }
        
        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.3);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .card-panel {
            background-color: var(--card-bg);
            backdrop-filter: var(--card-blur);
            -webkit-backdrop-filter: var(--card-blur);
            border-radius: var(--card-radius);
            box-shadow: 0 8px 24px var(--shadow-color);
            padding: 16px;
            margin-bottom: 15px;
            transition: var(--transition-normal);
            border: var(--card-border);
        }
        
        .card-panel:hover {
            box-shadow: 0 12px 28px var(--shadow-hover);
            transform: translateY(-2px);
        }
        
        .status {
            color: var(--neutral-500);
            font-size: 0.9em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            backdrop-filter: var(--card-blur);
            -webkit-backdrop-filter: var(--card-blur);
            padding: 12px 16px;
            border-radius: var(--card-radius);
            border: var(--card-border);
            box-shadow: 0 8px 24px var(--shadow-color);
            transition: var(--transition-normal);
        }
        
        .status:hover {
            box-shadow: 0 12px 28px var(--shadow-hover);
            transform: translateY(-2px);
        }
        
        .user-status, .online-status {
            display: flex;
            align-items: center;
            background-color: rgba(var(--primary-color-rgb), 0.08);
            padding: 8px 14px;
            border-radius: 12px;
            transition: var(--transition-normal);
        }
        
        .user-status:hover, .online-status:hover {
            background-color: rgba(var(--primary-color-rgb), 0.12);
            transform: translateY(-2px);
        }
        
        .status-label {
            font-size: 0.85rem;
            color: var(--neutral-600);
            margin-right: 10px;
            font-weight: 500;
        }
        
        [data-theme="dark"] .status-label {
            color: var(--neutral-400);
        }
        
        .badge, .user-badge {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
            box-shadow: 0 2px 10px rgba(var(--primary-color-rgb), 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .badge::before, .user-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s ease;
        }
        
        .badge:hover::before, .user-badge:hover::before {
            left: 100%;
        }
        
        .user-badge {
            background: linear-gradient(135deg, var(--tertiary-color), #5EBEAB);
            box-shadow: 0 2px 10px rgba(var(--tertiary-color-rgb, 128, 206, 184), 0.3);
        }
        
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            
            .theme-switch {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
            }
            
            #chat {
                height: calc(100vh - 220px);
            }
            
            .message {
                max-width: 95%;
                padding: 8px 12px;
            }
            
            .emoji-panel {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .status {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .input-area {
                flex-wrap: wrap;
            }
            
            .send-text {
                display: none;
            }
        }
        
        @media (min-width: 1200px) {
            body {
                max-width: 1000px;
            }
            
            #chat {
                height: 550px;
            }
        }
        
        #nickname-form {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            background-color: var(--chat-bg);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        #nickname {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            flex-grow: 1;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        #nickname:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        .typing-indicator {
            font-style: italic;
            color: var(--neutral-500);
            height: 20px;
            margin-top: 5px;
            animation: pulse 1.5s infinite;
        }
        
        .typing-indicator.active {
            animation: pulse 1.5s infinite;
        }
        
        /* 表情选择器样式 */
        .emoji-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background-color: var(--neutral-200);
            width: 44px;
            height: 44px;
        }
        
        [data-theme="dark"] .emoji-button {
            background-color: var(--neutral-700);
        }
        
        .emoji-button:hover {
            background-color: var(--neutral-300);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .emoji-button:hover {
            background-color: var(--neutral-600);
        }
        
        .emoji-panel {
            position: absolute;
            bottom: 60px;
            left: 0;
            background-color: var(--chat-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            z-index: 10;
            animation: fadeIn 0.3s ease;
            display: none;
            transition: all 0.3s ease;
        }
        
        .emoji-panel.active {
            display: grid;
        }
        
        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .emoji-item:hover {
            background-color: var(--msg-bg);
            transform: scale(1.1);
        }
        
        /* 主题切换按钮 */
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background-color: var(--button-bg);
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        background-color 0.3s ease;
            z-index: 100;
        }
        
        .theme-switch:hover {
            background-color: var(--button-hover);
            transform: translateY(-3px) rotate(15deg);
        }
        
        .theme-switch:active {
            transform: translateY(0) rotate(0);
        }
        
        /* 添加图标按钮样式 */
        .icon-button {
            background: none;
            border: none;
            font-size: 1.2rem;
            padding: 4px;
            cursor: pointer;
            border-radius: 50%;
            color: var(--text-color);
            transition: all 0.2s ease;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .icon-button:hover {
            background-color: var(--neutral-200);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .icon-button:hover {
            background-color: var(--neutral-700);
        }
        
        /* 增强可访问性 */
        :focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* 新增卡片面板样式 */
        .card-panel {
            background-color: var(--chat-bg);
            border-radius: 16px;
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .card-panel:hover {
            box-shadow: 0 6px 16px var(--shadow-hover);
        }
        
        /* 头部样式 */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
        }
        
        .logo-area h1 {
            margin: 0;
        }
        
        /* 用户状态样式 */
        .status-label {
            font-size: 0.9rem;
            color: var(--neutral-500);
            margin-right: 8px;
        }
        
        .user-status, .online-status {
            display: flex;
            align-items: center;
            background-color: rgba(var(--primary-color-rgb), 0.05);
            padding: 6px 12px;
            border-radius: 8px;
        }
        
        .badge, .user-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .user-badge {
            background-color: var(--success-color);
        }
        
        /* 聊天容器 */
        .chat-container {
            padding: 0;
            overflow: hidden;
        }
        
        .chat-container #chat {
            border: none;
            box-shadow: none;
            margin-bottom: 0;
            height: 400px;
        }
        
        /* 发送按钮 */
        .send-button {
            gap: 6px;
        }
        
        .send-icon {
            font-size: 1.2rem;
        }
        
        /* 表情容器 */
        .emoji-container {
            position: relative;
        }
        
        /* 消息样式增强 */
        .message-footer {
            font-size: 0.7rem;
            color: var(--neutral-400);
            text-align: right;
            margin-top: 4px;
        }
        
        /* 输入框容器 */
        .input-area {
            margin-bottom: 15px;
        }
        
        /* 声音控制 */
        .sound-control {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        /* 表单标题 */
        .form-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* 页脚 */
        .app-footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            color: var(--neutral-500);
            font-size: 0.85rem;
        }
        
        /* 主题过渡动画 */
        .theme-transition * {
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease !important;
        }
        
        /* 增强动画效果 */
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* 应用动画 */
        .message:not(.own-message) {
            animation: slideIn 0.3s ease forwards;
        }
        
        .message.own-message {
            animation: slideInRight 0.3s ease forwards;
        }
        
        .card-panel {
            animation: scaleIn 0.4s ease-out forwards;
        }
        
        /* 按钮点击特效 */
        button:active {
            transform: scale(0.95);
        }
        
        /* 消息时间线 */
        .chat-container #chat {
            position: relative;
        }
        
        .chat-container #chat::after {
            content: '';
            position: absolute;
            left: 35px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--border-color);
            z-index: 0;
            opacity: 0.5;
        }
        
        /* 滚动指示器 */
        .scroll-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 2px 8px var(--shadow-color);
            z-index: 10;
        }
        
        .scroll-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 输入框焦点增强 */
        #input:focus, #nickname:focus {
            transform: translateY(-2px);
        }
        
        /* 通知样式 */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(30px);
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
            text-align: center;
            min-width: 200px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 选中文本颜色 */
        ::selection {
            background-color: var(--primary-light);
            color: white;
        }
        
        /* 滚动条优化 */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--neutral-400) transparent;
        }
        
        *::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        *::-webkit-scrollbar-thumb {
            background-color: var(--neutral-400);
            border-radius: 3px;
        }
        
        *::-webkit-scrollbar-track {
            background-color: transparent;
        }
        
        /* 媒体上传按钮样式 */
        .media-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background-color: var(--neutral-200);
            width: 44px;
            height: 44px;
        }
        
        [data-theme="dark"] .media-button {
            background-color: var(--neutral-700);
        }
        
        .media-button:hover {
            background-color: var(--neutral-300);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .media-button:hover {
            background-color: var(--neutral-600);
        }
        
        .media-upload {
            position: relative;
        }
        
        /* 语音消息按钮样式 */
        .voice-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background-color: var(--neutral-200);
            width: 44px;
            height: 44px;
        }
        
        [data-theme="dark"] .voice-button {
            background-color: var(--neutral-700);
        }
        
        .voice-button:hover {
            background-color: var(--neutral-300);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .voice-button:hover {
            background-color: var(--neutral-600);
        }
        
        .voice-button.recording {
            background-color: var(--error-color);
            animation: pulse 1.5s infinite;
        }
        
        [data-theme="dark"] .voice-button.recording {
            background-color: var(--error-color);
        }
        
        .voice-message {
            position: relative;
        }
        
        .recording-timer {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--error-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        
        .recording-timer.active {
            opacity: 1;
        }
        
        /* 媒体预览区域样式 */
        .media-preview-container {
            background-color: var(--chat-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 10px 0;
            overflow: hidden;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .media-preview-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }
        
        .media-preview-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            max-height: 160px;
            overflow-y: auto;
        }
        
        .file-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2px 5px;
            font-size: 0.7rem;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 0 0 8px 8px;
        }
        
        .media-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: transform 0.2s ease;
        }
        
        .media-item:hover {
            transform: scale(1.05);
        }
        
        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-item .remove-media {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .media-item:hover .remove-media {
            opacity: 1;
        }
        
        /* 消息中的媒体样式 */
        .message-media {
            margin-top: 8px;
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .message-media img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .message-media img:hover {
            transform: scale(1.02);
        }
        
        .message-media video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
        }
        
        /* 消息中的音频样式 */
        .message-audio {
            margin-top: 8px;
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .audio-play-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .audio-play-button:hover {
            transform: scale(1.1);
            background-color: var(--primary-dark);
        }
        
        .audio-waveform {
            flex-grow: 1;
            height: 24px;
            background-image: linear-gradient(
                var(--primary-light) 1px, 
                transparent 1px
            ), linear-gradient(
                90deg, 
                transparent 0%, 
                var(--primary-color) 35%, 
                var(--primary-color) 65%, 
                transparent 100%
            );
            background-size: 8px 8px, 100% 100%;
            background-position: 0 center;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .audio-duration {
            font-size: 0.8rem;
            color: var(--neutral-600);
            flex-shrink: 0;
        }
        
        [data-theme="dark"] .audio-duration {
            color: var(--neutral-300);
        }
        
        /* 媒体加载进度样式 */
        .upload-progress {
            height: 4px;
            background-color: var(--neutral-200);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0;
            transition: width 0.3s ease;
        }
        
        /* 升级后的媒体全屏预览 */
        .media-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .media-fullscreen.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .media-fullscreen img, .media-fullscreen video {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .media-fullscreen .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .media-fullscreen .close-fullscreen:hover {
            opacity: 1;
            transform: scale(1.1);
            background-color: rgba(0, 0, 0, 0.6);
        }
        
        /* 音频预览样式 */
        .voice-preview-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .voice-preview-player:hover {
            background-color: rgba(var(--primary-color-rgb), 0.2);
        }
        
        .audio-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .voice-item {
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }
        
        /* 消息操作菜单样式 */
        .message-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 5;
            transform: translateY(-5px);
        }

        .message:hover .message-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .message-menu-button {
            background: rgba(var(--primary-color-rgb), 0.1);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--primary-color);
            opacity: 0.8;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-menu-button:hover {
            background-color: rgba(var(--primary-color-rgb), 0.2);
            color: var(--primary-color);
            opacity: 1;
            transform: rotate(90deg);
        }

        .message-context-menu {
            position: absolute;
            background-color: var(--card-bg);
            backdrop-filter: var(--card-blur);
            -webkit-backdrop-filter: var(--card-blur);
            border: var(--card-border);
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow-color);
            padding: 8px 0;
            min-width: 160px;
            z-index: 1000;
            animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: top right;
            display: none;
            overflow: hidden;
        }

        .message-context-menu.show {
            display: block;
        }

        .menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            transition: width 0.2s ease;
            z-index: -1;
        }

        .menu-item:hover::before {
            width: 100%;
        }

        .menu-item:hover {
            background-color: transparent;
        }

        .menu-item.delete {
            color: var(--error-color);
        }

        .menu-item.delete::before {
            background-color: rgba(var(--error-color-rgb, 255, 122, 107), 0.1);
        }

        .menu-icon {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        
        /* 编辑模式样式 */
        .message.editing .message-text {
            display: none;
        }
        
        .edit-input-container {
            display: none;
            margin-top: 8px;
        }
        
        .message.editing .edit-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-input {
            padding: 10px 14px;
            border: 1px solid rgba(var(--neutral-300-rgb, 194, 200, 220), 0.4);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.95rem;
            width: 100%;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .edit-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.15);
        }
        
        .edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .edit-actions button {
            padding: 6px 14px;
            height: auto;
            font-size: 0.85rem;
            border-radius: 8px;
        }
        
        .cancel-edit {
            background-color: rgba(var(--neutral-500-rgb, 115, 122, 151), 0.2);
            color: var(--neutral-700);
        }
        
        [data-theme="dark"] .cancel-edit {
            color: var(--neutral-300);
        }
        
        .cancel-edit:hover {
            background-color: rgba(var(--neutral-500-rgb, 115, 122, 151), 0.3);
        }
        
        /* 删除和编辑标记 */
        .message-deleted {
            font-style: italic;
            color: var(--neutral-500);
            opacity: 0.8;
            padding: 6px 10px;
            background-color: rgba(var(--neutral-500-rgb, 115, 122, 151), 0.1);
            border-radius: 8px;
            display: inline-block;
        }
        
        .message-edited-mark {
            font-size: 0.75rem;
            color: var(--accent-color);
            margin-left: 5px;
            opacity: 0.8;
        }
        
        .avatar:hover .cat-emoji {
            transform: rotate(15deg);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
        }
        
        .message.own-message .user-info {
            flex-direction: row-reverse;
        }
        
        .message-content {
            margin-top: 5px;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }
        
        .message-header {
            font-size: 0.8rem;
            color: var(--neutral-500);
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .message-sender {
            font-weight: 600;
            color: var(--neutral-600);
            position: relative;
        }
        
        .message-sender::before {
            content: '';
            position: absolute;
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background-color: var(--tertiary-color);
            left: -14px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .message:hover .message-sender::before {
            opacity: 1;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--neutral-400);
        }
        
        .message-text {
            margin-top: 6px;
            line-height: 1.5;
            font-size: 0.95rem;
            position: relative;
        }
        
        /* 媒体消息样式更新 */
        .message-media {
            margin-top: 12px;
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .message-media img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .message-media img:hover {
            transform: scale(1.03);
        }
        
        .message-media video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            cursor: pointer;
        }
        
        .message-media::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
            pointer-events: none;
        }
        
        /* 音频消息样式更新 */
        .message-audio {
            margin-top: 8px;
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(var(--primary-color-rgb), 0.15);
            transition: all 0.3s ease;
        }
        
        .message-audio:hover {
            background-color: rgba(var(--primary-color-rgb), 0.15);
            transform: translateY(-2px);
        }
        
        .audio-play-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb, 255, 122, 107), 0.3);
        }
        
        .audio-play-button:hover {
            transform: scale(1.15);
            background-color: var(--accent-light);
            box-shadow: 0 6px 16px rgba(var(--accent-color-rgb, 255, 122, 107), 0.4);
        }
        
        .audio-waveform {
            flex-grow: 1;
            height: 32px;
            background-image: 
                radial-gradient(circle, var(--accent-light) 1px, transparent 1px),
                linear-gradient(
                    90deg, 
                    transparent 0%, 
                    var(--accent-color) 40%, 
                    var(--accent-color) 60%, 
                    transparent 100%
                );
            background-size: 6px 6px, 100% 100%;
            background-position: 0 center;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .audio-waveform::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(var(--accent-color-rgb, 255, 122, 107), 0.3) 20%, 
                rgba(var(--accent-color-rgb, 255, 122, 107), 0.3) 80%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .audio-waveform:hover::before {
            opacity: 1;
        }
        
        .audio-duration {
            font-size: 0.85rem;
            color: var(--accent-dark);
            flex-shrink: 0;
            font-weight: 500;
        }
        
        [data-theme="dark"] .audio-duration {
            color: var(--accent-light);
        }
        
        /* 输入区域按钮样式 */
        .emoji-button, .media-button, .voice-button {
            background: rgba(var(--primary-color-rgb), 0.1);
            border: none;
            font-size: 1.5rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 44px;
            height: 44px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--primary-color);
        }
        
        [data-theme="dark"] .emoji-button, 
        [data-theme="dark"] .media-button, 
        [data-theme="dark"] .voice-button {
            background: rgba(var(--primary-color-rgb), 0.2);
            color: var(--neutral-200);
        }
        
        .emoji-button:hover, 
        .media-button:hover, 
        .voice-button:hover {
            background: rgba(var(--primary-color-rgb), 0.2);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.25);
            color: var(--primary-light);
        }
        
        [data-theme="dark"] .emoji-button:hover, 
        [data-theme="dark"] .media-button:hover, 
        [data-theme="dark"] .voice-button:hover {
            background: rgba(var(--primary-color-rgb), 0.3);
            color: white;
        }
        
        .voice-button.recording {
            background-color: var(--error-color);
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 5px rgba(var(--error-color-rgb, 255, 122, 107), 0.3);
        }
        
        [data-theme="dark"] .voice-button.recording {
            background-color: var(--error-color);
        }
        
        /* 卡片面板样式 */
        #nickname-form {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            background-color: var(--card-bg);
            backdrop-filter: var(--card-blur);
            -webkit-backdrop-filter: var(--card-blur);
            padding: 15px;
            border-radius: var(--card-radius);
            box-shadow: 0 8px 24px var(--shadow-color);
            transition: var(--transition-normal);
            border: var(--card-border);
            position: relative;
            overflow: hidden;
        }
        
        #nickname-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0.7;
        }
        
        #nickname {
            padding: 10px 14px;
            border: 1px solid rgba(var(--neutral-300-rgb, 194, 200, 220), 0.4);
            border-radius: 8px;
            flex-grow: 1;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition-normal);
            font-family: inherit;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        #nickname:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.15);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-area">
            <h1>🐱 猫咪聊天 | Cat Talk</h1>
        </div>
        <div class="theme-switch" id="theme-switch" title="切换主题">
            🌙
        </div>
    </header>
    
    <div id="nickname-form" class="card-panel">
        <div class="form-title">设置你的昵称</div>
        <input type="text" id="nickname" placeholder="输入您喜欢的昵称" maxlength="20">
        <button onclick="setNickname()">保存</button>
    </div>

    <div class="status card-panel">
        <div class="user-status">
            <span class="status-label">您的身份:</span>
            <div class="user-badge">
                <span id="user-id"></span>
            </div>
        </div>
        <div class="online-status">
            <span class="status-label">在线用户:</span>
            <div class="badge">
                <span id="online-count">-</span>
            </div>
        </div>
    </div>
    
    <div class="chat-container card-panel">
        <div id="chat"></div>
        <div class="typing-indicator" id="typing-indicator"></div>
    </div>
    
    <div class="input-area">
        <div class="emoji-container">
            <button class="emoji-button" id="emoji-button" title="选择表情">😊</button>
            <div class="emoji-panel" id="emoji-panel"></div>
        </div>
        
        <div class="media-upload">
            <button class="media-button" id="media-button" title="上传照片或视频">📷</button>
            <input type="file" id="file-input" accept="image/*, video/*" style="display: none;" multiple>
        </div>
        
        <div class="voice-message">
            <button class="voice-button" id="voice-button" title="发送语音消息">🎤</button>
        </div>
        
        <input type="text" id="input" placeholder="输入消息..." onkeyup="updateTypingStatus()" onkeypress="if(event.key === 'Enter') sendMessage()">
        <button class="send-button" onclick="sendMessage()">
            <span class="send-icon">📨</span>
            <span class="send-text">发送</span>
        </button>
    </div>
    
    <!-- 媒体预览区域 -->
    <div class="media-preview-container" id="media-preview-container" style="display: none;">
        <div class="media-preview-header">
            <span>待上传媒体文件</span>
            <button class="icon-button" id="clear-media" title="清除所有媒体">❌</button>
        </div>
        <div class="media-preview-content" id="media-preview-content"></div>
    </div>
    
    <div class="sound-control">
        <button id="mute-button" class="icon-button" title="静音通知">
            🔔
        </button>
    </div>
    
    <footer class="app-footer">
        <div class="footer-content">
            <p>基于Firebase实时数据库 · 猫咪聊天 Cat Talk</p>
        </div>
    </footer>
    
    <script type="module">
        // 导入Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            set, 
            onChildAdded, 
            onValue, 
            query, 
            limitToLast,
            onDisconnect,
            serverTimestamp,
            remove,
            get,
            update
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDkygULk8HZXnGpICuCVcyAztaz80efePk",
            authDomain: "cattalk-ade50.firebaseapp.com",
            databaseURL: "https://cattalk-ade50-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cattalk-ade50",
            storageBucket: "cattalk-ade50.firebasestorage.app",
            messagingSenderId: "210485142610",
            appId: "1:210485142610:web:de99542e92e93cde236b8b",
            measurementId: "G-8GL4789D12"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');
        const onlineRef = ref(db, 'online');
        const typingRef = ref(db, 'typing');
        
        // 存储待上传的媒体文件
        let selectedMediaFiles = [];
        
        // 随机猫咪名字列表
        const catNames = [
            "咪咪", "花花", "小橘", "黑豆", "雪球", 
            "胖虎", "奶茶", "球球", "豆豆", "小花",
            "毛线", "点点", "虎斑", "星星", "灰灰",
            "小黑", "斑斑", "糖糖", "米米", "小奶",
            "可乐", "巧克力", "饼干", "太阳", "月亮",
            "玉米", "牛奶", "蓝莓", "香草", "棉花糖"
        ];
        
        // 猫咪表情列表
        const catEmojis = [
            "🐱", "😺", "😸", "😹", "😻", "😼", "😽", "🙀", "😿", "😾",
            "🐈", "🐈‍⬛", "🦁", "🐯", "🐅", "🐆", "🦂", "🦊"
        ];
        
        // 生成随机名字
        function generateRandomName() {
            const randomPrefix = catNames[Math.floor(Math.random() * catNames.length)];
            return `${randomPrefix}猫`;
        }
        
        // 使用用户ID生成唯一颜色和表情
        function generateRandomColor(seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                const adjustedValue = Math.max(Math.min(value, 220), 100);
                color += ('00' + adjustedValue.toString(16)).substr(-2);
            }
            
            return color;
        }
        
        function getRandomCatEmoji(userId) {
            // 使用用户ID生成固定的表情索引
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % catEmojis.length;
            return catEmojis[index];
        }
        
        // 生成头像HTML
        function getAvatarHTML(userId, nickname) {
            const color = generateRandomColor(userId);
            const emoji = getRandomCatEmoji(userId);
            
            return `
                <div class="avatar" style="background-color: ${color};">
                    <span class="cat-emoji">${emoji}</span>
                </div>
            `;
        }

        // 用户标识管理
        let userId = localStorage.getItem('firebase-chat-userId');
        if (!userId) {
            userId = Math.random().toString(36).substring(2, 8);
            localStorage.setItem('firebase-chat-userId', userId);
        }
        
        // 获取或生成昵称
        let nickname = localStorage.getItem('firebase-chat-nickname');
        if (!nickname) {
            nickname = generateRandomName();
            localStorage.setItem('firebase-chat-nickname', nickname);
        }
        
        // 显示用户ID和昵称
        document.getElementById('user-id').textContent = `${nickname} (${userId.substring(0, 4)})`;
        document.getElementById('nickname').value = nickname;
        
        // 更新在线状态
        const myStatusRef = ref(db, `online/${userId}`);
        set(myStatusRef, {
            online: true,
            nickname: nickname,
            lastSeen: serverTimestamp()
        });
        
        // 用户断开连接时自动更新状态
        onDisconnect(myStatusRef).remove();
        
        // 监听在线用户数量
        onValue(onlineRef, (snapshot) => {
            const data = snapshot.val() || {};
            const onlineUsers = Object.keys(data).length;
            document.getElementById('online-count').textContent = onlineUsers;
        });

        // 监听新消息
        const recentMessagesQuery = query(messagesRef, limitToLast(50));
        onChildAdded(recentMessagesQuery, (snapshot) => {
            const msg = snapshot.val();
            addMessageToChat(msg, snapshot.key);
            
            // 如果消息不是自己发的，播放提示音
            if (msg.userId !== userId) {
                playNotificationSound();
            }
        });
        
        // 监听消息更新（用于编辑和删除）
        onValue(recentMessagesQuery, (snapshot) => {
            if (!snapshot.exists()) return;
            
            const messages = snapshot.val();
            for (const [messageId, message] of Object.entries(messages)) {
                // 检查消息是否在DOM中存在
                const existingMessage = document.getElementById(`msg-${messageId}`);
                if (existingMessage) {
                    // 更新消息内容
                    addMessageToChat(message, messageId);
                }
            }
        });
        
        // 监听输入状态
        onValue(typingRef, (snapshot) => {
            const typingUsers = snapshot.val() || {};
            const typingUserIds = Object.keys(typingUsers).filter(id => id !== userId && typingUsers[id].typing);
            const typingIndicator = document.getElementById('typing-indicator');
            
            if (typingUserIds.length > 0) {
                const names = typingUserIds.map(id => {
                    return typingUsers[id].nickname || `用户${id.substring(0, 4)}`;
                });
                
                if (names.length === 1) {
                    typingIndicator.textContent = `${names[0]} 正在输入...`;
                } else if (names.length === 2) {
                    typingIndicator.textContent = `${names[0]} 和 ${names[1]} 正在输入...`;
                } else {
                    typingIndicator.textContent = `${names.length} 个用户正在输入...`;
                }
            } else {
                typingIndicator.textContent = '';
            }
        });

        // 监听页面可见性变化
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // 页面变为可见时，更新在线状态
                set(myStatusRef, {
                    online: true,
                    nickname: nickname,
                    lastSeen: serverTimestamp()
                });
            }
        });

        // 发送消息函数
        window.sendMessage = async function() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            
            // 如果既没有文本消息也没有媒体文件，则不发送
            if (!text && selectedMediaFiles.length === 0) return;
            
            try {
                // 上传媒体文件（如果有）
                let mediaData = {urls: [], types: []};
                let audioDurations = [];
                
                if (selectedMediaFiles.length > 0) {
                    mediaData = await uploadMediaFiles();
                    
                    // 收集音频持续时间数据
                    selectedMediaFiles.forEach((mediaItem, index) => {
                        if (mediaItem.type === 'audio' && mediaItem.duration) {
                            audioDurations[index] = mediaItem.duration;
                        }
                    });
                }
                
                // 发送消息
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, {
                    text: text,
                    userId: userId,
                    nickname: nickname,
                    timestamp: Date.now(),
                    mediaUrls: mediaData.urls,
                    mediaTypes: mediaData.types,
                    audioDurations: audioDurations.length > 0 ? audioDurations : null
                });
                
                // 清空输入
                input.value = '';
                
                // 清除正在输入状态
                const typingUserRef = ref(db, `typing/${userId}`);
                set(typingUserRef, { typing: false, nickname: nickname });
            } catch (error) {
                console.error("发送消息时出错:", error);
                showNotification("发送消息失败，请重试");
            }
        };
        
        // 设置昵称
        window.setNickname = function() {
            const nicknameInput = document.getElementById('nickname');
            const newNickname = nicknameInput.value.trim();
            
            if (newNickname) {
                nickname = newNickname;
                localStorage.setItem('firebase-chat-nickname', nickname);
                document.getElementById('user-id').textContent = `${nickname} (${userId.substring(0, 4)})`;
                
                // 更新在线状态中的昵称
                set(myStatusRef, {
                    online: true,
                    nickname: nickname,
                    lastSeen: serverTimestamp()
                });
                
                alert(`昵称已更新为: ${nickname}`);
            }
        };
        
        // 更新正在输入状态
        let typingTimeout;
        window.updateTypingStatus = function() {
            const typingUserRef = ref(db, `typing/${userId}`);
            set(typingUserRef, { typing: true, nickname: nickname });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(typingUserRef, { typing: false, nickname: nickname });
            }, 3000);
        };

        // HTML转义函数，防止XSS攻击
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // 将消息添加到聊天区域
        function addMessageToChat(message, messageId) {
            if (!message) return;
            
            const isOwnMessage = message.userId === userId;
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwnMessage ? 'own-message' : ''} clearfix`;
            messageElement.id = `msg-${messageId}`;
            messageElement.dataset.messageId = messageId;
            
            // 格式化时间
            const messageDate = new Date(message.timestamp);
            const timeString = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = messageDate.toLocaleDateString();
            
            // 处理消息内容，替换表情
            const hasText = message.text && message.text.trim() !== '';
            const processedText = hasText ? replaceEmojisInText(escapeHtml(message.text)) : '';
            
            // 检查消息是否已被删除
            const isDeleted = message.deleted === true;
            
            // 生成用户信息HTML
            let messageHTML = `
                <div class="user-info">
                    ${getAvatarHTML(message.userId, message.nickname)}
                    <div class="message-meta">
                        <div class="message-header">
                            <span class="message-sender">${escapeHtml(message.nickname || '匿名猫咪')}</span>
                            <span class="message-time">${timeString}</span>
                        </div>
                    </div>
                </div>
                <div class="message-content">
            `;
            
            // 为自己的消息添加操作菜单
            if (isOwnMessage && !isDeleted) {
                messageHTML += `
                    <div class="message-actions">
                        <button class="message-menu-button" title="消息操作">⋮</button>
                        <div class="message-context-menu">
                            <div class="menu-item edit-message" data-message-id="${messageId}">
                                <span class="menu-icon">✏️</span>编辑消息
                            </div>
                            <div class="menu-item delete menu-delete-message" data-message-id="${messageId}">
                                <span class="menu-icon">🗑️</span>删除消息
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 添加文本内容（如果有且未被删除）
            if (isDeleted) {
                messageHTML += `<div class="message-deleted">此消息已删除</div>`;
            } else if (hasText) {
                messageHTML += `<div class="message-text">${processedText}`;
                
                // 如果消息被编辑过，添加标记
                if (message.edited) {
                    messageHTML += `<span class="message-edited-mark">(已编辑)</span>`;
                }
                
                messageHTML += `</div>`;
                
                // 添加编辑输入框（默认隐藏）
                messageHTML += `
                    <div class="edit-input-container">
                        <textarea class="edit-input" rows="3">${message.text}</textarea>
                        <div class="edit-actions">
                            <button class="cancel-edit">取消</button>
                            <button class="save-edit" data-message-id="${messageId}">保存</button>
                        </div>
                    </div>
                `;
            }
            
            // 添加媒体内容（如果有且未被删除）
            if (!isDeleted && message.mediaUrls && message.mediaUrls.length > 0) {
                message.mediaUrls.forEach((url, index) => {
                    const mediaType = message.mediaTypes && message.mediaTypes[index] ? message.mediaTypes[index] : detectMediaType(url);
                    
                    if (mediaType === 'image') {
                        // 检查是否是Base64编码的图片
                        if (url.startsWith('data:image/')) {
                            messageHTML += `
                                <div class="message-media">
                                    <img src="${url}" alt="图片" loading="lazy" onclick="showFullscreenMedia('${url}', 'image')">
                                </div>
                            `;
                        } else {
                            // 远程图片URL
                            messageHTML += `
                                <div class="message-media">
                                    <img src="${url}" alt="图片" loading="lazy" onclick="showFullscreenMedia('${url}', 'image')">
                                </div>
                            `;
                        }
                    } else if (mediaType === 'video') {
                        // 检查是否是Base64编码的视频
                        if (url.startsWith('data:video/')) {
                            messageHTML += `
                                <div class="message-media">
                                    <video src="${url}" controls preload="metadata"></video>
                                </div>
                            `;
                        } else {
                            // 远程视频URL
                            messageHTML += `
                                <div class="message-media">
                                    <video src="${url}" controls preload="metadata"></video>
                                </div>
                            `;
                        }
                    } else if (mediaType === 'audio') {
                        // 显示音频消息
                        const duration = message.audioDurations && message.audioDurations[index] 
                            ? message.audioDurations[index] 
                            : null;
                        
                        messageHTML += renderAudioMessage(url, duration);
                    }
                });
            }
            
            // 添加消息时间戳
            messageHTML += `<div class="message-footer">${dateString}</div></div>`;
            
            // 设置消息内容
            messageElement.innerHTML = messageHTML;
            
            // 添加到聊天区域并滚动到底部
            const chatElement = document.getElementById('chat');
            
            // 检查是否已存在相同ID的消息（用于编辑更新）
            const existingMessage = document.getElementById(`msg-${messageId}`);
            if (existingMessage) {
                chatElement.replaceChild(messageElement, existingMessage);
            } else {
                chatElement.appendChild(messageElement);
            }
            
            // 添加菜单点击事件
            const menuButton = messageElement.querySelector('.message-menu-button');
            const contextMenu = messageElement.querySelector('.message-context-menu');
            
            if (menuButton && contextMenu) {
                menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    contextMenu.classList.toggle('show');
                });
                
                // 点击其他地方关闭菜单
                document.addEventListener('click', () => {
                    if (contextMenu.classList.contains('show')) {
                        contextMenu.classList.remove('show');
                    }
                });
                
                // 防止菜单点击事件冒泡
                contextMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // 为移动设备添加长按显示菜单的功能
            if (isOwnMessage && !isDeleted) {
                let longPressTimer;
                const longPressDuration = 500; // 长按500毫秒触发
                
                messageElement.addEventListener('touchstart', (e) => {
                    longPressTimer = setTimeout(() => {
                        if (contextMenu) {
                            // 阻止默认行为和冒泡
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // 显示菜单
                            contextMenu.classList.add('show');
                            
                            // 关闭任何其他打开的菜单
                            document.querySelectorAll('.message-context-menu.show').forEach(menu => {
                                if (menu !== contextMenu) {
                                    menu.classList.remove('show');
                                }
                            });
                        }
                    }, longPressDuration);
                });
                
                // 如果手指移动，取消长按操作
                messageElement.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                });
                
                // 触摸结束时，清除计时器
                messageElement.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                });
            }
            
            // 添加编辑按钮事件
            const editButton = messageElement.querySelector('.edit-message');
            if (editButton) {
                editButton.addEventListener('click', () => {
                    messageElement.classList.add('editing');
                    const editInput = messageElement.querySelector('.edit-input');
                    if (editInput) {
                        editInput.focus();
                        // 将光标移到文本末尾
                        editInput.selectionStart = editInput.value.length;
                    }
                });
            }
            
            // 添加取消编辑按钮事件
            const cancelEditButton = messageElement.querySelector('.cancel-edit');
            if (cancelEditButton) {
                cancelEditButton.addEventListener('click', () => {
                    messageElement.classList.remove('editing');
                });
            }
            
            // 添加保存编辑按钮事件
            const saveEditButton = messageElement.querySelector('.save-edit');
            if (saveEditButton) {
                saveEditButton.addEventListener('click', () => {
                    const editInput = messageElement.querySelector('.edit-input');
                    if (editInput) {
                        const newText = editInput.value.trim();
                        const messageId = saveEditButton.dataset.messageId;
                        editMessage(messageId, newText);
                        messageElement.classList.remove('editing');
                    }
                });
            }
            
            // 添加编辑文本框的键盘事件（回车保存，Esc取消）
            const editInput = messageElement.querySelector('.edit-input');
            if (editInput) {
                editInput.addEventListener('keydown', (e) => {
                    // 按回车键保存 (不带Shift键)
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // 防止添加新行
                        const newText = editInput.value.trim();
                        const messageId = messageElement.dataset.messageId;
                        editMessage(messageId, newText);
                        messageElement.classList.remove('editing');
                    }
                    // 按Esc键取消
                    else if (e.key === 'Escape') {
                        messageElement.classList.remove('editing');
                    }
                });
            }
            
            // 添加删除按钮事件
            const deleteButton = messageElement.querySelector('.menu-delete-message');
            if (deleteButton) {
                deleteButton.addEventListener('click', () => {
                    const messageId = deleteButton.dataset.messageId;
                    if (confirm('确定要删除这条消息吗？')) {
                        deleteMessage(messageId);
                    }
                });
            }
            
            // 滚动到底部，但仅当用户在底部或者是自己发的消息时
            const isNearBottom = chatElement.scrollHeight - chatElement.scrollTop - chatElement.clientHeight < 150;
            if (isNearBottom || isOwnMessage) {
                chatElement.scrollTop = chatElement.scrollHeight;
            }
            
            // 如果不是自己的消息且页面不可见，播放提示音
            if (!isOwnMessage && document.hidden) {
                playNotificationSound();
            }
        }
        
        // 根据URL检测媒体类型
        function detectMediaType(url) {
            // 检查是否是Base64编码的图片或视频
            if (url.startsWith('data:image/')) return 'image';
            if (url.startsWith('data:video/')) return 'video';
            if (url.startsWith('data:audio/')) return 'audio';
            
            // 检查文件扩展名（用于URL）
            const ext = url.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'];
            const videoExts = ['mp4', 'webm', 'ogg', 'mov'];
            const audioExts = ['mp3', 'wav', 'ogg', 'aac', 'm4a'];
            
            if (imageExts.includes(ext)) return 'image';
            if (videoExts.includes(ext)) return 'video';
            if (audioExts.includes(ext)) return 'audio';
            
            // 如果无法从扩展名判断，则从URL中查找标识字符串
            if (url.includes('image') || url.includes('img')) return 'image';
            if (url.includes('video') || url.includes('mp4')) return 'video';
            if (url.includes('audio') || url.includes('sound') || url.includes('voice')) return 'audio';
            
            // 默认返回图片类型
            return 'image';
        }
        
        // 替换文本中的表情符号为表情图像
        function replaceEmojisInText(text) {
            // 简单替换常见表情符号
            return text.replace(/:\)/g, '😊')
                       .replace(/:\(/g, '😞')
                       .replace(/:\D/g, '😃')
                       .replace(/;\)/g, '😉')
                       .replace(/:P/g, '😋')
                       .replace(/:O/g, '😲')
                       .replace(/:'\(/g, '😢');
        }
        
        // 显示全屏媒体
        window.showFullscreenMedia = function(url, type) {
            // 安全检查，确保URL有效
            if (!url) {
                console.error("无效的媒体URL");
                return;
            }
            
            // 获取或创建全屏查看器
            let fullscreenViewer = document.getElementById('media-fullscreen');
            if (!fullscreenViewer) {
                createMediaFullscreenViewer();
                fullscreenViewer = document.getElementById('media-fullscreen');
            }
            
            // 获取关闭按钮
            let closeButton = fullscreenViewer.querySelector('.close-fullscreen');
            if (!closeButton) {
                closeButton = document.createElement('button');
                closeButton.className = 'close-fullscreen';
                closeButton.innerHTML = '×';
                closeButton.onclick = () => {
                    fullscreenViewer.classList.remove('active');
                };
                fullscreenViewer.appendChild(closeButton);
            }
            
            // 清除旧内容，保留关闭按钮
            const buttons = fullscreenViewer.innerHTML;
            fullscreenViewer.innerHTML = '';
            fullscreenViewer.innerHTML = buttons;
            
            // 创建媒体元素
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                img.alt = "全屏图片";
                fullscreenViewer.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.autoplay = true;
                fullscreenViewer.appendChild(video);
            }
            
            // 显示全屏查看器
            fullscreenViewer.classList.add('active');
            
            // 添加Escape键关闭功能
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    fullscreenViewer.classList.remove('active');
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        };
        
        // 表情选择器初始化
        function initEmojiSelector() {
            const emojiPanel = document.getElementById('emoji-panel');
            const emojiButton = document.getElementById('emoji-button');
            const input = document.getElementById('input');
            
            // 常用表情列表
            const emojis = [
                '😊', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '😉', 
                '😍', '🥰', '😘', '😚', '😋', '😛', '😜', '😝', '🤪', '🤨',
                '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟',
                '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭',
                '💪', '👍', '👎', '✌️', '🤞', '🤘', '🤙', '👋', '🙏', '❤️'
            ];
            
            // 生成表情面板内容
            emojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji;
                emojiSpan.className = 'emoji-item';
                emojiSpan.addEventListener('click', () => {
                    input.value += emoji;
                    emojiPanel.classList.remove('active');
                    input.focus();
                });
                emojiPanel.appendChild(emojiSpan);
            });
            
            // 表情按钮点击事件
            emojiButton.addEventListener('click', (event) => {
                emojiPanel.classList.toggle('active');
                event.stopPropagation();
            });
            
            // 点击其他地方关闭表情面板
            document.addEventListener('click', (event) => {
                if (!event.target.matches('#emoji-button, #emoji-panel, #emoji-panel *')) {
                    emojiPanel.classList.remove('active');
                }
            });
        }
        
        // 主题切换功能 - 修复ID引用错误
        function initThemeSwitcher() {
            const themeSwitch = document.getElementById('theme-switch');
            const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // 检查本地存储中的主题设置
            let currentTheme = localStorage.getItem('theme');
            
            // 如果没有设置，使用系统偏好
            if (!currentTheme) {
                currentTheme = prefersDarkMode ? 'dark' : 'light';
                localStorage.setItem('theme', currentTheme);
            }
            
            // 应用主题
            document.documentElement.dataset.theme = currentTheme;
            updateThemeIcon(currentTheme);
            
            // 添加切换事件
            themeSwitch.addEventListener('click', () => {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.dataset.theme = newTheme;
                localStorage.setItem('theme', newTheme);
                currentTheme = newTheme;
                
                // 更新图标
                updateThemeIcon(newTheme);
                
                // 添加过渡效果
                document.documentElement.classList.add('theme-transition');
                setTimeout(() => {
                    document.documentElement.classList.remove('theme-transition');
                }, 500);
            });
            
            // 监听系统主题变化
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('theme')) {
                        const newTheme = e.matches ? 'dark' : 'light';
                        document.documentElement.dataset.theme = newTheme;
                        currentTheme = newTheme;
                        updateThemeIcon(newTheme);
                    }
                });
            }
        }
        
        function updateThemeIcon(theme) {
            const themeSwitch = document.getElementById('theme-switch');
            themeSwitch.innerHTML = theme === 'dark' ? '☀️' : '🌙';
            themeSwitch.title = theme === 'dark' ? '切换到浅色模式' : '切换到深色模式';
        }
        
        // 初始化通知声音
        function initNotificationSound() {
            // 使用一个简短清脆的提示音
            const notificationSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAACAAADrAAICAgICAgICAgICAgQEBAQEBAQEBAQEBAgICAgICAgICAgICAoKCgoKCgoKCgoKDA//Dw8PDw8PDw8PDw8P/////////////////////8AAAA//MUZAAAAAGkAAAAAAAAA0gAAAAATEFNRTMuMTAw//NUZC8AAAGkAAAAAAAAAUQAAAAATZV//NUZDUAAAGkAAAAAAAAAUgAAAAA4OS45//NUZEIAAAGBAAAAAAAAAUQAAAAALD//NUZDmAAAGkAAAAAAAAAUgAAAAAyLjE//NUZEAAAAGRAAAAAAAAAUAAAAABA");
            
            // 设置静音按钮
            const muteButton = document.getElementById('mute-button');
            const isMuted = localStorage.getItem('isMuted') === 'true';
            
            // 应用保存的静音状态
            notificationSound.muted = isMuted;
            updateMuteButtonIcon(isMuted);
            
            // 添加点击事件
            muteButton.addEventListener('click', () => {
                const newMutedState = !notificationSound.muted;
                notificationSound.muted = newMutedState;
                localStorage.setItem('isMuted', newMutedState);
                
                // 更新图标和工具提示
                updateMuteButtonIcon(newMutedState);
                
                // 显示提示信息
                showNotification(newMutedState ? '已关闭通知声音' : '已开启通知声音');
            });
            
            // 提供播放声音的函数
            window.playNotificationSound = function() {
                if (!notificationSound.muted && document.hidden) {
                    // 重置声音进度并播放
                    notificationSound.currentTime = 0;
                    notificationSound.play()
                        .catch(error => console.log('播放提示音失败:', error));
                }
            };
            
            // 测试声音按钮
            const testSoundButton = document.createElement('button');
            testSoundButton.className = 'icon-button';
            testSoundButton.innerHTML = '🔊';
            testSoundButton.title = '测试通知声音';
            testSoundButton.onclick = function() {
                if (!notificationSound.muted) {
                    notificationSound.currentTime = 0;
                    notificationSound.play()
                        .then(() => showNotification('通知声音测试'))
                        .catch(error => showNotification('无法播放声音，请检查浏览器设置'));
                } else {
                    showNotification('请先取消静音');
                }
            };
            
            // 添加测试按钮到声音控制区
            document.querySelector('.sound-control').appendChild(testSoundButton);
        }
        
        // 更新静音按钮图标
        function updateMuteButtonIcon(isMuted) {
            const muteButton = document.getElementById('mute-button');
            muteButton.innerHTML = isMuted ? '🔕' : '🔔';
            muteButton.title = isMuted ? '开启通知声音' : '关闭通知声音';
        }
        
        // 显示通知提示
        function showNotification(message, type = 'default') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // 根据类型添加样式
            if (type === 'warning') {
                notification.style.backgroundColor = 'var(--warning-color)';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'var(--error-color)';
            } else if (type === 'success') {
                notification.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'info') {
                notification.style.backgroundColor = 'var(--info-color)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 淡入效果
            setTimeout(() => notification.classList.add('show'), 10);
            
            // 3秒后淡出
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // 页面加载完成后初始化功能
        window.addEventListener('DOMContentLoaded', () => {
            initEmojiSelector();
            initThemeSwitcher();
            initNotificationSound();
            initMediaUpload();
            initVoiceMessage(); // 初始化语音消息功能
            
            // 添加滚动到底部按钮功能
            const chatContainer = document.querySelector('.chat-container');
            const chat = document.getElementById('chat');
            
            if (chatContainer && chat) {
                const scrollIndicator = document.createElement('div');
                scrollIndicator.className = 'scroll-indicator';
                scrollIndicator.innerHTML = '⬇️';
                scrollIndicator.title = '滚动到底部';
                chatContainer.appendChild(scrollIndicator);
                
                // 监听滚动事件
                chat.addEventListener('scroll', () => {
                    const isNearBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 100;
                    if (!isNearBottom && chat.scrollHeight > chat.clientHeight) {
                        scrollIndicator.classList.add('visible');
                    } else {
                        scrollIndicator.classList.remove('visible');
                    }
                });
                
                // 点击滚动到底部
                scrollIndicator.addEventListener('click', () => {
                    chat.scrollTop = chat.scrollHeight;
                });
            }
            
            // 创建全屏媒体预览容器
            createMediaFullscreenViewer();
        });
        
        // 初始化语音消息功能
        function initVoiceMessage() {
            const voiceButton = document.getElementById('voice-button');
            if (!voiceButton) return;
            
            let mediaRecorder = null;
            let audioChunks = [];
            let isRecording = false;
            let recordingStartTime = 0;
            let recordingTimer = null;
            
            // 创建录音计时器元素
            const timerElement = document.createElement('div');
            timerElement.className = 'recording-timer';
            timerElement.textContent = '00:00';
            document.querySelector('.voice-message').appendChild(timerElement);
            
            // 点击录音按钮开始/停止录音
            voiceButton.addEventListener('click', async () => {
                if (!isRecording) {
                    try {
                        // 请求麦克风权限
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        
                        // 开始录制
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        
                        // 收集录音数据
                        mediaRecorder.addEventListener('dataavailable', (event) => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        });
                        
                        // 录音结束处理
                        mediaRecorder.addEventListener('stop', async () => {
                            // 停止所有轨道以关闭麦克风
                            stream.getTracks().forEach(track => track.stop());
                            
                            // 如果录音太短，则忽略
                            const duration = (Date.now() - recordingStartTime) / 1000;
                            if (duration < 1) {
                                showNotification('录音时间太短', 'warning');
                                return;
                            }
                            
                            // 处理录音数据
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            
                            // 检查文件大小
                            if (audioBlob.size > 3 * 1024 * 1024) {
                                showNotification('录音文件过大，请录制较短的语音消息', 'warning');
                                return;
                            }
                            
                            try {
                                // 转换为Base64
                                const base64Audio = await readFileAsBase64(audioBlob);
                                
                                // 添加到媒体文件中
                                selectedMediaFiles.push({
                                    file: audioBlob,
                                    id: Math.random().toString(36).substring(2, 10),
                                    type: 'audio',
                                    duration: Math.round(duration),
                                    base64: base64Audio
                                });
                                
                                // 更新媒体预览
                                updateVoicePreview();
                                
                                // 直接发送消息，如果希望先预览则注释此行
                                // sendMessage();
                            } catch (error) {
                                console.error('处理录音时出错:', error);
                                showNotification('处理录音时出错', 'error');
                            }
                        });
                        
                        // 开始录音
                        mediaRecorder.start();
                        isRecording = true;
                        recordingStartTime = Date.now();
                        
                        // 修改按钮样式
                        voiceButton.classList.add('recording');
                        voiceButton.title = '点击停止录音';
                        
                        // 显示计时器
                        timerElement.classList.add('active');
                        updateRecordingTimer();
                        
                    } catch (error) {
                        console.error('无法访问麦克风:', error);
                        showNotification('无法访问麦克风，请检查浏览器权限设置', 'error');
                    }
                } else {
                    // 停止录音
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    isRecording = false;
                    
                    // 恢复按钮样式
                    voiceButton.classList.remove('recording');
                    voiceButton.title = '发送语音消息';
                    
                    // 隐藏计时器
                    timerElement.classList.remove('active');
                    clearInterval(recordingTimer);
                }
            });
            
            // 更新录音计时器
            function updateRecordingTimer() {
                clearInterval(recordingTimer);
                recordingTimer = setInterval(() => {
                    const seconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                    
                    // 限制录音时长为60秒
                    if (seconds >= 60) {
                        voiceButton.click(); // 自动停止录音
                    }
                }, 1000);
            }
            
            // 更新语音预览
            function updateVoicePreview() {
                // 过滤出语音类型的媒体
                const voiceFiles = selectedMediaFiles.filter(item => item.type === 'audio');
                
                // 如果没有语音文件，不显示预览
                if (voiceFiles.length === 0) {
                    return;
                }
                
                // 显示预览容器
                const mediaPreviewContainer = document.getElementById('media-preview-container');
                const mediaPreviewContent = document.getElementById('media-preview-content');
                
                if (!mediaPreviewContainer || !mediaPreviewContent) {
                    return;
                }
                
                mediaPreviewContainer.style.display = 'block';
                
                // 为每个语音文件创建预览
                voiceFiles.forEach(voiceItem => {
                    // 创建预览元素
                    const voicePreview = document.createElement('div');
                    voicePreview.className = 'media-item voice-item';
                    voicePreview.dataset.id = voiceItem.id;
                    
                    // 创建音频播放UI
                    const audioPlayer = document.createElement('div');
                    audioPlayer.className = 'voice-preview-player';
                    audioPlayer.innerHTML = `
                        <div class="audio-icon">🔊</div>
                        <div class="audio-duration">${formatDuration(voiceItem.duration)}</div>
                    `;
                    
                    // 添加删除按钮
                    const removeButton = document.createElement('button');
                    removeButton.className = 'remove-media';
                    removeButton.innerHTML = '×';
                    removeButton.addEventListener('click', () => {
                        selectedMediaFiles = selectedMediaFiles.filter(item => item.id !== voiceItem.id);
                        updateMediaPreview();
                    });
                    
                    voicePreview.appendChild(audioPlayer);
                    voicePreview.appendChild(removeButton);
                    
                    // 添加到预览区域
                    mediaPreviewContent.appendChild(voicePreview);
                    
                    // 点击预览播放音频
                    voicePreview.addEventListener('click', (e) => {
                        // 忽略删除按钮的点击
                        if (e.target === removeButton || e.target.closest('.remove-media')) {
                            return;
                        }
                        
                        // 创建临时音频元素播放
                        const audio = new Audio(voiceItem.base64);
                        audio.play();
                    });
                });
                
                // 更新预览标题
                const previewHeader = mediaPreviewContainer.querySelector('.media-preview-header span');
                if (previewHeader) {
                    const totalFiles = selectedMediaFiles.length;
                    const voiceCount = voiceFiles.length;
                    previewHeader.textContent = `待发送媒体文件 (${totalFiles}，包含${voiceCount}条语音)`;
                }
            }
            
            // 格式化时长显示
            function formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }
        
        // 在消息中显示音频
        function renderAudioMessage(base64Data, duration) {
            const durationText = typeof duration === 'number' ? formatDuration(duration) : '0:00';
            
            return `
                <div class="message-audio">
                    <button class="audio-play-button" onclick="playAudio('${base64Data}')">▶️</button>
                    <div class="audio-waveform" onclick="playAudio('${base64Data}')"></div>
                    <span class="audio-duration">${durationText}</span>
                </div>
            `;
        }
        
        // 格式化音频时长
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // 播放音频
        window.playAudio = function(audioSrc) {
            const audio = new Audio(audioSrc);
            audio.play().catch(error => {
                console.error('播放音频出错:', error);
                showNotification('无法播放音频，请检查浏览器设置', 'error');
            });
        };
        
        // 创建全屏媒体预览容器
        function createMediaFullscreenViewer() {
            const fullscreenViewer = document.createElement('div');
            fullscreenViewer.className = 'media-fullscreen';
            fullscreenViewer.id = 'media-fullscreen';
            
            const closeButton = document.createElement('button');
            closeButton.className = 'close-fullscreen';
            closeButton.innerHTML = '×';
            closeButton.onclick = () => {
                fullscreenViewer.classList.remove('active');
                fullscreenViewer.innerHTML = '';
                fullscreenViewer.appendChild(closeButton);
            };
            
            fullscreenViewer.appendChild(closeButton);
            document.body.appendChild(fullscreenViewer);
            
            // 点击背景关闭预览
            fullscreenViewer.addEventListener('click', (e) => {
                if (e.target === fullscreenViewer) {
                    fullscreenViewer.classList.remove('active');
                    fullscreenViewer.innerHTML = '';
                    fullscreenViewer.appendChild(closeButton);
                }
            });
        }
        
        // 初始化媒体上传功能
        function initMediaUpload() {
            const mediaButton = document.getElementById('media-button');
            const fileInput = document.getElementById('file-input');
            const mediaPreviewContainer = document.getElementById('media-preview-container');
            const mediaPreviewContent = document.getElementById('media-preview-content');
            const clearMediaButton = document.getElementById('clear-media');
            
            // 点击媒体按钮触发文件选择
            mediaButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 媒体按钮工具提示
            mediaButton.title = "上传照片或视频 (图片不限大小，视频<3MB)";
            
            // 监听文件选择事件
            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                // 显示文件处理中提示
                if (files.length > 3) {
                    showNotification(`正在处理 ${files.length} 个文件，请稍候...`);
                }
                
                // 将选择的文件添加到待上传列表
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileType = file.type.split('/')[0]; // 'image' or 'video'
                    
                    if (fileType === 'video') {
                        // 视频大小限制 (3MB)
                        if (file.size > 3 * 1024 * 1024) {
                            showNotification(`视频 ${file.name} 过大，限制3MB以内`, 'warning');
                            continue;
                        }
                    } else if (fileType === 'image') {
                        // 图片会被自动压缩，无需限制大小
                        // 但太大的文件会影响性能，显示警告
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification(`图片 ${file.name} 较大，将被压缩处理`, 'info');
                        }
                    } else {
                        // 检查文件类型
                        showNotification(`不支持的文件类型: ${file.type}`, 'warning');
                        continue;
                    }
                    
                    // 添加到待处理列表
                    selectedMediaFiles.push({
                        file: file,
                        id: Math.random().toString(36).substring(2, 10),
                        type: fileType
                    });
                }
                
                // 重置文件输入框
                fileInput.value = '';
                
                // 更新预览
                updateMediaPreview();
            });
            
            // 清除所有待上传媒体
            clearMediaButton.addEventListener('click', () => {
                selectedMediaFiles = [];
                updateMediaPreview();
                showNotification('已清除所有待上传媒体');
            });
            
            // 更新媒体预览
            function updateMediaPreview() {
                mediaPreviewContent.innerHTML = '';
                
                if (selectedMediaFiles.length === 0) {
                    mediaPreviewContainer.style.display = 'none';
                    return;
                }
                
                mediaPreviewContainer.style.display = 'block';
                
                // 更新预览标题
                const previewHeader = mediaPreviewContainer.querySelector('.media-preview-header span');
                if (previewHeader) {
                    const audioCount = selectedMediaFiles.filter(item => item.type === 'audio').length;
                    const imageCount = selectedMediaFiles.filter(item => item.type === 'image').length;
                    const videoCount = selectedMediaFiles.filter(item => item.type === 'video').length;
                    
                    let headerText = `待发送媒体文件 (${selectedMediaFiles.length})`;
                    
                    if (audioCount > 0) {
                        headerText += ` - 包含${audioCount}条语音`;
                    }
                    
                    previewHeader.textContent = headerText;
                }
                
                selectedMediaFiles.forEach((mediaItem) => {
                    const file = mediaItem.file;
                    const mediaId = mediaItem.id;
                    const fileType = mediaItem.type;
                    
                    const mediaItemElement = document.createElement('div');
                    mediaItemElement.className = 'media-item';
                    mediaItemElement.dataset.id = mediaId;
                    
                    // 创建预览元素
                    if (fileType === 'image') {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        mediaItemElement.appendChild(img);
                    } else if (fileType === 'video') {
                        const video = document.createElement('video');
                        video.src = URL.createObjectURL(file);
                        video.muted = true; // 自动播放需要静音
                        video.controls = true;
                        mediaItemElement.appendChild(video);
                    } else if (fileType === 'audio') {
                        // 创建音频预览
                        const audioPlayer = document.createElement('div');
                        audioPlayer.className = 'voice-preview-player';
                        audioPlayer.innerHTML = `
                            <div class="audio-icon">🔊</div>
                            <div class="audio-duration">${formatDuration(mediaItem.duration || 0)}</div>
                        `;
                        mediaItemElement.appendChild(audioPlayer);
                        
                        // 点击预览播放音频
                        audioPlayer.addEventListener('click', () => {
                            const audio = new Audio(mediaItem.base64);
                            audio.play().catch(error => {
                                console.error('播放音频出错:', error);
                                showNotification('无法播放音频，请检查浏览器设置', 'error');
                            });
                        });
                    }
                    
                    // 添加文件信息
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'file-info';
                    fileInfo.textContent = formatFileSize(file.size);
                    mediaItemElement.appendChild(fileInfo);
                    
                    // 添加删除按钮
                    const removeButton = document.createElement('button');
                    removeButton.className = 'remove-media';
                    removeButton.innerHTML = '×';
                    removeButton.addEventListener('click', () => {
                        selectedMediaFiles = selectedMediaFiles.filter(item => item.id !== mediaId);
                        updateMediaPreview();
                    });
                    
                    mediaItemElement.appendChild(removeButton);
                    mediaPreviewContent.appendChild(mediaItemElement);
                });
            }
            
            // 格式化文件大小
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
        }
        
        // 上传所有选定的媒体文件，并返回Base64编码后的数据
        async function uploadMediaFiles() {
            if (selectedMediaFiles.length === 0) return {urls: [], types: []};
            
            const mediaData = [];
            const mediaTypes = [];
            const maxSizeForBase64 = 1 * 1024 * 1024; // 1MB限制
            
            showNotification(`正在处理 ${selectedMediaFiles.length} 个媒体文件，请稍候...`);
            
            // 创建处理进度指示器
            const progressElement = document.createElement('div');
            progressElement.className = 'upload-progress';
            const progressBar = document.createElement('div');
            progressBar.className = 'upload-progress-bar';
            progressElement.appendChild(progressBar);
            document.querySelector('.media-preview-container').appendChild(progressElement);
            
            try {
                for (let i = 0; i < selectedMediaFiles.length; i++) {
                    const mediaItem = selectedMediaFiles[i];
                    const file = mediaItem.file;
                    const fileType = mediaItem.type; // 'image', 'video' 或 'audio'
                    
                    // 更新进度条
                    progressBar.style.width = ((i / selectedMediaFiles.length) * 100) + '%';
                    
                    // 根据不同类型处理文件
                    if (fileType === 'image') {
                        // 检查文件大小
                        if (file.size > maxSizeForBase64) {
                            showNotification(`图片 ${file.name} 过大，进行压缩处理...`);
                            // 在添加到列表前执行压缩
                            const compressedBase64 = await compressImage(file, 0.8, 800);
                            mediaData.push(compressedBase64);
                        } else {
                            // 小文件直接转换为Base64
                            const base64 = await readFileAsBase64(file);
                            mediaData.push(base64);
                        }
                        mediaTypes.push('image');
                    } else if (fileType === 'video') {
                        // 视频仍然使用原上传方式，但仅用于小视频
                        if (file.size > maxSizeForBase64 * 3) {
                            showNotification(`视频 ${file.name} 过大，请上传小于3MB的视频`);
                            continue;
                        }
                        
                        // 小视频转换为Base64
                        const base64 = await readFileAsBase64(file);
                        mediaData.push(base64);
                        mediaTypes.push('video');
                    } else if (fileType === 'audio') {
                        // 处理音频文件 - 语音消息
                        if (file.size > maxSizeForBase64 * 3) {
                            showNotification(`音频文件过大，请录制较短的语音消息`, 'warning');
                            continue;
                        }
                        
                        // 如果已经有base64编码，直接使用
                        if (mediaItem.base64) {
                            mediaData.push(mediaItem.base64);
                        } else {
                            // 否则转换为Base64
                            const base64 = await readFileAsBase64(file);
                            mediaData.push(base64);
                        }
                        mediaTypes.push('audio');
                    }
                    
                    // 更新进度条
                    progressBar.style.width = (((i + 1) / selectedMediaFiles.length) * 100) + '%';
                }
                
                // 所有文件处理完成
                showNotification(`${mediaData.length} 个媒体文件处理成功`);
                
                // 清空待上传列表
                selectedMediaFiles = [];
                document.getElementById('media-preview-container').style.display = 'none';
                
                // 返回媒体数据和类型
                return {urls: mediaData, types: mediaTypes};
                
            } catch (error) {
                console.error("媒体处理过程中出错:", error);
                showNotification("媒体处理失败，请重试");
                return {urls: [], types: []};
            } finally {
                // 移除进度条
                if (progressElement.parentNode) {
                    progressElement.parentNode.removeChild(progressElement);
                }
            }
        }
        
        // 读取文件为Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // 压缩图片
        function compressImage(file, quality = 0.8, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        // 计算新的宽高
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        // 使用Canvas压缩
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为Base64
                        const dataUrl = canvas.toDataURL(file.type, quality);
                        resolve(dataUrl);
                    };
                    img.onerror = function(error) {
                        reject(error);
                    };
                    img.src = event.target.result;
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 编辑消息功能
        function editMessage(messageId, newText) {
            if (!messageId || !newText) return;
            
            // 防止XSS，过滤输入
            newText = newText.trim();
            if (newText.length === 0) {
                showNotification("消息内容不能为空", "warning");
                return;
            }
            
            if (newText.length > 500) {
                showNotification("消息内容不能超过500个字符", "warning");
                return;
            }
            
            const messageRef = ref(db, `messages/${messageId}`);
            
            // 先获取消息，确保只有自己才能编辑
            get(messageRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const message = snapshot.val();
                    
                    // 检查是否是自己的消息
                    if (message.userId === userId) {
                        // 检查消息发送时间是否在48小时内
                        const messageTime = message.timestamp;
                        const currentTime = Date.now();
                        const hoursDifference = (currentTime - messageTime) / (1000 * 60 * 60);
                        
                        if (hoursDifference > 48) {
                            showNotification("无法编辑超过48小时的消息", "warning");
                            return;
                        }
                        
                        // 检查是否与原消息内容相同
                        if (message.text === newText) {
                            showNotification("消息内容未发生变化", "info");
                            return;
                        }
                        
                        // 更新消息
                        update(messageRef, {
                            text: newText,
                            edited: true,
                            editTimestamp: Date.now()
                        }).then(() => {
                            showNotification("消息已更新", "success");
                        }).catch((error) => {
                            console.error("编辑消息时出错:", error);
                            showNotification("编辑消息失败", "error");
                        });
                    } else {
                        showNotification("你只能编辑自己的消息", "warning");
                    }
                } else {
                    showNotification("找不到要编辑的消息", "error");
                }
            }).catch((error) => {
                console.error("获取消息时出错:", error);
                showNotification("获取消息失败", "error");
            });
        }
        
        // 删除消息功能
        function deleteMessage(messageId) {
            if (!messageId) return;
            
            const messageRef = ref(db, `messages/${messageId}`);
            
            // 先获取消息，确保只有自己才能删除
            get(messageRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const message = snapshot.val();
                    
                    // 检查是否是自己的消息
                    if (message.userId === userId) {
                        // 我们不实际删除消息，而是标记为已删除
                        update(messageRef, {
                            deleted: true,
                            deleteTimestamp: Date.now()
                        }).then(() => {
                            showNotification("消息已删除", "success");
                        }).catch((error) => {
                            console.error("删除消息时出错:", error);
                            showNotification("删除消息失败", "error");
                        });
                    } else {
                        showNotification("你只能删除自己的消息", "warning");
                    }
                } else {
                    showNotification("找不到要删除的消息", "error");
                }
            }).catch((error) => {
                console.error("获取消息时出错:", error);
                showNotification("获取消息失败", "error");
            });
        }
    </script>
</body>
</html> 